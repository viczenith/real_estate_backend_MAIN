<style>
    .main-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: var(--sidebar-width, 260px);
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
        z-index: 1001;
        overflow-y: auto;
        transition: all 0.3s ease;
    }

    .main-sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .main-sidebar-header h4 {
        color: white;
        font-weight: 600;
        margin: 0;
    }

    .main-sidebar-nav {
        padding: 1rem 0;
    }

    .main-nav-item {
        margin: 0 1rem 0.5rem 1rem;
    }

    .main-nav-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        font-weight: 500;
        position: relative;
    }

    .main-nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateX(5px);
    }

    .main-nav-link.active {
        background-color: var(--primary-color, #2563eb);
        color: white;
    }

    .main-nav-link i {
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
    }

    .nav-icon-wrapper {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
    }

    .nav-icon-wrapper i {
        margin-right: 0;
    }

    .nav-link-text {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .main-nav-badge {
        margin-left: auto;
        min-width: 28px;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
        background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
        color: #fff;
        font-size: 0.75rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
        transform-origin: center;
        opacity: 0;
        transform: scale(0.6);
        transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .main-nav-badge.show {
        opacity: 1;
        transform: scale(1);
        animation: badgePulse 1.4s ease-in-out infinite;
    }

    .nav-icon-wrapper .main-nav-badge {
        position: absolute;
        top: -6px;
        right: -10px;
        margin-left: 0;
    }

    @keyframes badgePulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.35);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(249, 115, 22, 0);
        }
    }
</style>

<div class="main-sidebar">
    <div class="main-sidebar-header">
        <h4><i class="fas fa-headset me-2"></i>Admin Support</h4>
    </div>
    <nav class="main-sidebar-nav">
        <div class="main-nav-item">
            <a href="{% url 'adminSupport:support_dashboard' %}" class="main-nav-link {% if request.resolver_match.url_name == 'support_dashboard' %}active{% endif %}">
                <i class="fas fa-users-cog"></i>
                Customer Relations
            </a>
        </div>
        <div class="main-nav-item">
            <a href="{% url 'adminSupport:app_content_management' %}" class="main-nav-link {% if request.resolver_match.url_name == 'app_content_management' %}active{% endif %}">
                <i class="fas fa-file-edit"></i>
                Content Management
            </a>
        </div>
        <div class="main-nav-item">
            <a href="{% url 'adminSupport:chat' %}" class="main-nav-link {% if request.resolver_match.url_name == 'chat' %}active{% endif %}">
                <span class="nav-icon-wrapper">
                    <i class="fas fa-comments"></i>
                    <span id="main-chat-badge" class="main-nav-badge"{% if unread_count|default:0 %} data-initial="{{ unread_count }}"{% endif %}></span>
                </span>
                <span class="nav-link-text">Chat Support</span>
            </a>
        </div>
        <hr style="margin: 1rem; border-color: rgba(255, 255, 255, 0.1);">
    </nav>
</div>

<script>
    (function () {
        if (window.__adminSupportSidebarInitialized) {
            return;
        }
        window.__adminSupportSidebarInitialized = true;

        const chatListPollUrl = '{% url "adminSupport:chat_list_partial" %}';

        function setChatBadge(badgeEl, count) {
            if (!badgeEl) return;
            if (count > 0) {
                badgeEl.textContent = String(count);
                badgeEl.classList.add('show');
            } else {
                badgeEl.classList.remove('show');
                badgeEl.textContent = '';
            }
        }

        async function refreshMainChatBadge(badgeEl) {
            if (!badgeEl) return;
            try {
                const response = await fetch(chatListPollUrl, {
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                });
                if (!response.ok) throw new Error('network');
                const data = await response.json();
                const totals = data?.totals || {};
                const totalThreads = Number(totals.client_threads || 0) + Number(totals.marketer_threads || 0);
                setChatBadge(badgeEl, totalThreads);
            } catch (error) {
                console.error('Unable to refresh chat badge:', error);
            }
        }

        function initSidebarBadge() {
            const badgeEl = document.getElementById('main-chat-badge');
            if (!badgeEl) return;

            const initialCount = parseInt(badgeEl.dataset.initial || '0', 10);
            if (!Number.isNaN(initialCount) && initialCount > 0) {
                setChatBadge(badgeEl, initialCount);
            }

            refreshMainChatBadge(badgeEl);
            setInterval(() => refreshMainChatBadge(badgeEl), 10000);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSidebarBadge);
        } else {
            initSidebarBadge();
        }
    })();
</script>
