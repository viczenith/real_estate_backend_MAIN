{% extends 'adminSupport/customer_relations_base.html' %}
{% load static %}

{% block title %}Special Days Manager{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.css" rel="stylesheet">
<style>
/* Special Days Manager Styles */
.special-days-container {
    background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
    min-height: 100vh;
    padding: 20px;
}

.page-header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.page-title {
    color: white;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.page-subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
    margin-bottom: 0;
}

/* Main Content Layout */
.content-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
    margin-bottom: 30px;
}

.main-panel {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 25px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.sidebar-panel {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 25px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    height: fit-content;
}

/* Calendar Styles */
.fc {
    font-family: 'Inter', sans-serif;
}

.fc-event {
    border-radius: 8px;
    border: none;
    padding: 2px 6px;
    font-weight: 500;
    cursor: pointer;
}

.fc-event-national {
    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
}

.fc-event-religious {
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
}

.fc-event-commercial {
    background: linear-gradient(45deg, #667eea, #764ba2);
}

.fc-event-custom {
    background: linear-gradient(45deg, #ffd93d, #ff6b35);
}

/* Special Days List */
.special-days-list {
    max-height: 600px;
    overflow-y: auto;
    margin-top: 20px;
}

.special-day-item {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    border-left: 5px solid #4ecdc4;
    transition: all 0.3s ease;
    cursor: pointer;
}

.special-day-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.special-day-item.national {
    border-left-color: #ff6b6b;
}

.special-day-item.religious {
    border-left-color: #4ecdc4;
}

.special-day-item.commercial {
    border-left-color: #667eea;
}

.special-day-item.custom {
    border-left-color: #ffd93d;
}

.day-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.day-title {
    font-weight: 600;
    font-size: 1.2rem;
    color: #333;
    margin: 0;
}

.day-date {
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.day-description {
    color: #666;
    margin-bottom: 15px;
    line-height: 1.5;
}

.day-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.detail-item {
    text-align: center;
    padding: 10px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
}

.detail-value {
    font-weight: 600;
    color: #4ecdc4;
    margin-bottom: 2px;
}

.detail-label {
    font-size: 0.8rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.day-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* Form Styles */
.form-floating label {
    color: #666;
}

.form-control:focus {
    border-color: #4ecdc4;
    box-shadow: 0 0 0 0.25rem rgba(78, 205, 196, 0.25);
}

.form-select:focus {
    border-color: #4ecdc4;
    box-shadow: 0 0 0 0.25rem rgba(78, 205, 196, 0.25);
}

/* Buttons */
.btn-primary {
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
    border: none;
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(78, 205, 196, 0.3);
    background: linear-gradient(45deg, #44a08d, #4ecdc4);
}

.btn-outline-primary {
    border-color: #4ecdc4;
    color: #4ecdc4;
    border-radius: 10px;
    font-weight: 600;
}

.btn-outline-primary:hover {
    background-color: #4ecdc4;
    border-color: #4ecdc4;
}

.btn-danger {
    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    border: none;
    border-radius: 10px;
}

.btn-success {
    background: linear-gradient(45deg, #51cf66, #40c057);
    border: none;
    border-radius: 10px;
}

/* Filter Controls */
.filter-controls {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

/* Legend */
.calendar-legend {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.legend-color.national {
    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
}

.legend-color.religious {
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
}

.legend-color.commercial {
    background: linear-gradient(45deg, #667eea, #764ba2);
}

.legend-color.custom {
    background: linear-gradient(45deg, #ffd93d, #ff6b35);
}

/* Modal Customizations */
.modal-content {
    border-radius: 20px;
    border: none;
}

.modal-header {
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
    color: white;
    border-radius: 20px 20px 0 0;
    border-bottom: none;
}

.modal-title {
    font-weight: 600;
}

.btn-close {
    filter: brightness(0) invert(1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
    
    .page-title {
        font-size: 2rem;
    }
    
    .filter-row {
        grid-template-columns: 1fr;
    }
    
    .day-details {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block customer_relations_content %}
<div class="special-days-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-calendar-star me-3"></i>
            Special Days Manager
        </h1>
        <p class="page-subtitle">
            Manage holidays, special events, and automated campaign triggers
        </p>
    </div>

    <!-- Main Content -->
    <div class="content-grid">
        <!-- Calendar Section -->
        <div class="main-panel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">
                    <i class="fas fa-calendar me-2"></i>
                    Special Days Calendar
                </h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSpecialDayModal">
                    <i class="fas fa-plus me-2"></i>
                    Add Special Day
                </button>
            </div>

            <!-- Calendar Legend -->
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-color national"></div>
                    <span>National Holidays</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color religious"></div>
                    <span>Religious Events</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color commercial"></div>
                    <span>Commercial Days</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color custom"></div>
                    <span>Custom Events</span>
                </div>
            </div>

            <!-- Calendar -->
            <div id="specialDaysCalendar"></div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar-panel">
            <h4 class="mb-3">
                <i class="fas fa-list me-2"></i>
                Upcoming Events
            </h4>

            <!-- Filter Controls -->
            <div class="filter-controls">
                <div class="filter-row">
                    <select class="form-select" id="eventTypeFilter">
                        <option value="all">All Types</option>
                        <option value="national">National</option>
                        <option value="religious">Religious</option>
                        <option value="commercial">Commercial</option>
                        <option value="custom">Custom</option>
                    </select>
                    <select class="form-select" id="monthFilter">
                        <option value="all">All Months</option>
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                </div>
            </div>

            <!-- Special Days List -->
            <div class="special-days-list" id="specialDaysList">
                <!-- Special days will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Add Special Day Modal -->
<div class="modal fade" id="addSpecialDayModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Add Special Day
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSpecialDayForm">
                    <div class="form-floating mb-3">
                        <select class="form-select" id="modalSpecialDaySelect">
                            <option value="">Select a special day (this month)</option>
                        </select>
                        <label for="modalSpecialDaySelect">Pick Special Day (auto-fills below)</label>
                        <div class="form-text">This list updates with the calendar month and includes Nigerian special days.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="eventName" placeholder="Event Name" required>
                                <label for="eventName">Event Name</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="eventType" required>
                                    <option value="">Select Type</option>
                                    <option value="national">National Holiday</option>
                                    <option value="religious">Religious Event</option>
                                    <option value="commercial">Commercial Day</option>
                                    <option value="custom">Custom Event</option>
                                </select>
                                <label for="eventType">Event Type</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="eventDate" required>
                                <label for="eventDate">Event Date</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="recurrencePattern">
                                    <option value="yearly">Yearly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="none">One-time</option>
                                </select>
                                <label for="recurrencePattern">Recurrence</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="eventDescription" style="height: 100px" placeholder="Description"></textarea>
                        <label for="eventDescription">Description</label>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="isNationalHoliday">
                                <label class="form-check-label" for="isNationalHoliday">
                                    National Holiday
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="isReligiousHoliday">
                                <label class="form-check-label" for="isReligiousHoliday">
                                    Religious Holiday
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-3">
                        <select class="form-select" id="targetAudience" multiple>
                            <option value="all">All Users</option>
                            <option value="clients">Clients</option>
                            <option value="marketers">Marketers</option>
                            <option value="top_clients">VIP Clients</option>
                            <option value="new_clients">New Clients</option>
                        </select>
                        <label for="targetAudience">Target Audience</label>
                    </div>

                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="campaignMessage" style="height: 120px" placeholder="Campaign Message Template"></textarea>
                        <label for="campaignMessage">Campaign Message Template</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSpecialDay()">
                    <i class="fas fa-save me-2"></i>
                    Save Special Day
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Special Day Modal -->
<div class="modal fade" id="editSpecialDayModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Edit Special Day
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Similar form structure as add modal -->
                <div id="editFormContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateSpecialDay()">
                    <i class="fas fa-save me-2"></i>
                    Update Special Day
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js"></script>
<script>
class SpecialDaysManager {
    constructor() {
        this.calendar = null;
        this.specialDays = [];
        this.API_SPECIAL_DAYS = "{% url 'adminSupport:api_special_days' %}";
        this.init();
    }

    init() {
        this.initializeCalendar();
        this.setupEventListeners();
        // Initial load for current month
        this.loadSpecialDays(new Date()).then(() => {
            if (this.calendar) this.calendar.refetchEvents();
        });
        this.scheduleMonthAutoAdvance();
    }

    initializeCalendar() {
        const calendarEl = document.getElementById('specialDaysCalendar');
        this.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            firstDay: 0, // Sunday-first
            events: this.getCalendarEvents.bind(this),
            eventContent: (arg) => {
                // Add ðŸ‡³ðŸ‡¬ flag for Nigerian events
                const isNG = this.isNigeriaEvent(arg.event.extendedProps);
                const title = arg.event.title || '';
                const innerHtml = `${isNG ? 'ðŸ‡³ðŸ‡¬ ' : ''}${title}`;
                return { html: `<div class="fc-event-title">${this.escapeHtml(innerHtml)}</div>` };
            },
            eventClick: this.handleEventClick.bind(this),
            dateClick: this.handleDateClick.bind(this),
            height: 'auto',
            themeSystem: 'bootstrap5'
        });
        this.calendar.render();
    }

    // Utility for dynamic observances
    getNthWeekdayOfMonth(year, monthIndex, weekday, nth) {
        // weekday: 0=Sun..6=Sat, nth>=1
        const first = new Date(year, monthIndex, 1);
        const firstWeekday = first.getDay();
        let dayOfMonth = 1 + ((7 + weekday - firstWeekday) % 7) + (nth - 1) * 7;
        return new Date(year, monthIndex, dayOfMonth);
    }

    // Fallback list if all fetches fail
    loadDefaultSpecialDays() {
        const year = new Date().getFullYear();
        const pad = (n) => String(n).padStart(2, '0');
        // Dynamic dates
        const mothers = this.getNthWeekdayOfMonth(year, 4, 0, 2); // May (4), 2nd Sunday
        const fathers = this.getNthWeekdayOfMonth(year, 5, 0, 3); // June (5), 3rd Sunday
        this.specialDays = [
            { id: 1, name: "New Year's Day", type: 'national', date: `${year}-01-01`, description: "Nigeria New Year's Day", isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 2, name: 'Armed Forces Remembrance Day', type: 'national', date: `${year}-01-15`, description: 'Honoring Nigerian Armed Forces', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 3, name: "Valentine's Day", type: 'commercial', date: `${year}-02-14`, description: 'Valentineâ€™s Day', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 4, name: "Workers' Day", type: 'national', date: `${year}-05-01`, description: 'International Workersâ€™ Day', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 5, name: "Children's Day", type: 'custom', date: `${year}-05-27`, description: 'Nigeria Childrenâ€™s Day', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 6, name: "Mother's Day", type: 'custom', date: `${year}-${pad(mothers.getMonth()+1)}-${pad(mothers.getDate())}`, description: 'Motherâ€™s Day (observed)', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 7, name: "Father's Day", type: 'custom', date: `${year}-${pad(fathers.getMonth()+1)}-${pad(fathers.getDate())}`, description: 'Fatherâ€™s Day (observed)', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 8, name: 'Democracy Day', type: 'national', date: `${year}-06-12`, description: 'Nigeria Democracy Day', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 9, name: 'Independence Day', type: 'national', date: `${year}-10-01`, description: 'Nigeria Independence Day', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 10, name: "Teachers' Day", type: 'custom', date: `${year}-10-05`, description: 'World Teachersâ€™ Day (observed)', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 11, name: 'Christmas Day', type: 'religious', date: `${year}-12-25`, description: 'Christmas Day', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
            { id: 12, name: 'Boxing Day', type: 'national', date: `${year}-12-26`, description: 'Boxing Day', isRecurring: true, targetAudience: ['all'], extendedProps:{ countryCode:'NG', source:'nigerian' } },
        ];
        this.renderSpecialDaysList();
    }

    async getCalendarEvents(info, successCallback, failureCallback) {
        try {
            // Use the visible range's start month for loading
            const refDate = info && info.start ? info.start : new Date();
            await this.loadSpecialDays(refDate);
            const events = this.specialDays.map(day => ({
                id: day.id,
                title: day.name,
                start: day.date,
                className: `fc-event-${day.type}`,
                extendedProps: day.extendedProps || { type: day.type, description: day.description || '' }
            }));
            successCallback(events);
        } catch (e) {
            console.warn('Failed to load events for calendar:', e);
            const events = (this.specialDays || []).map(day => ({
                id: day.id,
                title: day.name,
                start: day.date,
                className: `fc-event-${day.type}`,
                extendedProps: { type: day.type }
            }));
            successCallback(events);
        }
    }

    renderSpecialDaysList() {
        const listContainer = document.getElementById('specialDaysList');
        const filteredDays = this.getFilteredSpecialDays();
        if (!filteredDays.length) {
            listContainer.innerHTML = '<div class="text-muted text-center py-3">No special days found.</div>';
            return;
        }
        listContainer.innerHTML = filteredDays.map(day => {
            const ng = this.isNigeriaEvent(day.extendedProps);
            const title = `${ng ? 'ðŸ‡³ðŸ‡¬ ' : ''}${this.escapeHtml(day.name)}`;
            return `
            <div class="special-day-item ${day.type}" onclick="showDayDetails(${day.id})">
                <div class="day-header">
                    <h5 class="day-title">${title}</h5>
                    <span class="day-date">${this.escapeHtml(this.formatDate(day.date))}</span>
                </div>
                ${day.description ? `<p class="day-description">${this.escapeHtml(day.description)}</p>` : ''}
                <div class="day-details">
                    <div class="detail-item">
                        <div class="detail-value">${this.escapeHtml(day.type.charAt(0).toUpperCase() + day.type.slice(1))}</div>
                        <div class="detail-label">Type</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${ng ? 'ðŸ‡³ðŸ‡¬ Nigeria' : (day.extendedProps?.countryCode || 'â€”')}</div>
                        <div class="detail-label">Country</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${day.isRecurring ? 'Yes' : 'No'}</div>
                        <div class="detail-label">Recurring</div>
                    </div>
                </div>
                <div class="day-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editSpecialDay(${day.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); createCampaign(${day.id})"><i class="fas fa-paper-plane"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteSpecialDay(${day.id})"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        }).join('');
    }

    getFilteredSpecialDays() {
        const typeFilter = document.getElementById('eventTypeFilter').value;
        const monthFilter = document.getElementById('monthFilter').value;
        
        return this.specialDays.filter(day => {
            const typeMatch = typeFilter === 'all' || day.type === typeFilter;
            const monthMatch = monthFilter === 'all' || new Date(day.date).getMonth() == monthFilter;
            return typeMatch && monthMatch;
        });
    }

    formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
        });
    }

    setupEventListeners() {
        document.getElementById('eventTypeFilter').addEventListener('change', () => {
            this.renderSpecialDaysList();
        });
        
        document.getElementById('monthFilter').addEventListener('change', () => {
            this.renderSpecialDaysList();
        });

        // When a predefined special day is chosen, auto-fill fields
        const sel = document.getElementById('modalSpecialDaySelect');
        if (sel) {
            sel.addEventListener('change', () => {
                const id = sel.value;
                if (!id) return; // cleared
                const day = this.specialDays.find(d => String(d.id) === String(id));
                if (!day) return;
                const nameEl = document.getElementById('eventName');
                const dateEl = document.getElementById('eventDate');
                const typeEl = document.getElementById('eventType');
                if (nameEl) nameEl.value = day.name || '';
                if (dateEl) dateEl.value = (day.date || '').slice(0,10);
                if (typeEl) typeEl.value = (day.type || 'custom');
            });
        }
    }

    handleEventClick(info) {
        const day = this.specialDays.find(d => d.id == info.event.id);
        if (day) {
            showDayDetails(day.id);
        }
    }

    handleDateClick(info) {
        // Pre-fill the add modal with the clicked date
        document.getElementById('eventDate').value = info.dateStr;
        const addModal = new bootstrap.Modal(document.getElementById('addSpecialDayModal'));
        addModal.show();
    }

    async loadSpecialDays(refDate) {
        // Load Nigerian and other special days from backend for the month of refDate
        const d = refDate ? new Date(refDate) : new Date();
        const year = d.getFullYear();
        const month = d.getMonth() + 1; // 1-based
        try {
            const resp = await fetch(`${this.API_SPECIAL_DAYS}?year=${year}&month=${month}`);
            if (!resp.ok) throw new Error('Backend returned error');
            const data = await resp.json();
            const events = Array.isArray(data.events) ? data.events : [];
            // Map backend events to local list structure and tag NG
            let mapped = events.map((ev, idx) => {
                const start = (ev.start || '').slice(0, 10);
                const name = ev.extendedProps?.name || ev.title || 'Event';
                const isNG = this.isNigeriaEvent(ev.extendedProps);
                // Heuristic for type: NG as 'national', others fallback 'custom' unless specified
                const type = isNG ? 'national' : (ev.extendedProps?.type || 'custom');
                return {
                    id: ev.id || `${year}${month}${idx}`,
                    name,
                    type,
                    date: start,
                    description: ev.title || name,
                    isRecurring: false,
                    targetAudience: ['all'],
                    extendedProps: ev.extendedProps || {}
                };
            });
            // If backend returns empty, fall back to Nager NG public holidays for that month
            if (mapped.length === 0) {
                try {
                    const r = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/NG`);
                    if (!r.ok) throw new Error('Nager NG API failed');
                    const holidays = await r.json();
                    const mm = String(month).padStart(2, '0');
                    mapped = holidays
                        .filter(h => (h.date||'').startsWith(`${year}-${mm}-`))
                        .map((h, i) => ({
                            id: `ng-${year}${mm}-${i}`,
                            name: h.localName || h.name,
                            type: 'national',
                            date: h.date,
                            description: h.name,
                            isRecurring: true,
                            targetAudience: ['all'],
                            extendedProps: { countryCode: 'NG', source: 'nigerian', name: h.localName || h.name, type: 'national' }
                        }));
                } catch (fallbackErr) {
                    // If Nager fails, use our default list filtered to current month
                    this.loadDefaultSpecialDays();
                    const mmIdx = month - 1;
                    mapped = this.specialDays.filter(sd => {
                        const dt = new Date(sd.date + 'T00:00:00');
                        return dt.getMonth() === mmIdx && dt.getFullYear() === year;
                    });
                }
            }
            this.specialDays = mapped;
            this.renderSpecialDaysList();
            this.populateSpecialDayDropdown();
        } catch (err) {
            console.warn('api_special_days failed, using fallback list', err);
            this.loadDefaultSpecialDays();
            this.populateSpecialDayDropdown();
        }
    }

    populateSpecialDayDropdown() {
        const sel = document.getElementById('modalSpecialDaySelect');
        if (!sel) return;
        const days = this.specialDays || [];
        if (days.length === 0) {
            sel.innerHTML = '<option value="">No special days found for this month</option>';
            return;
        }
        const options = ['<option value="">Select a special day (this month)</option>'].concat(
            days
                .slice()
                .sort((a,b)=> (a.date||'').localeCompare(b.date||'') || (a.name||'').localeCompare(b.name||''))
                .map(d => {
                    const nice = d.date ? new Date(d.date+'T00:00:00').toLocaleDateString(undefined,{ month:'short', day:'numeric' }) : '';
                    const prefix = (d.extendedProps && (d.extendedProps.countryCode==='NG' || (d.extendedProps.source||'').toLowerCase()==='nigerian')) ? 'ðŸ‡³ðŸ‡¬ ' : '';
                    const label = `${nice} â€” ${prefix}${this.escapeHtml(d.name || 'Event')}`;
                    return `<option value="${this.escapeHtml(String(d.id))}">${label}</option>`;
                })
        );
        sel.innerHTML = options.join('');
    }

    isNigeriaEvent(extendedProps) {
        try {
            if (!extendedProps) return false;
            if (extendedProps.countryCode === 'NG') return true;
            if ((extendedProps.source || '').toLowerCase() === 'nigerian') return true;
        } catch {}
        return false;
    }

    escapeHtml(s) {
        return (String(s || '')).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // Auto-advance calendar at month boundary (00:01 next month)
    scheduleMonthAutoAdvance() {
        const now = new Date();
        const nextMonthStart = new Date(now.getFullYear(), now.getMonth() + 1, 1, 0, 1, 0, 0);
        const delay = Math.max(5000, nextMonthStart.getTime() - now.getTime());
        setTimeout(async () => {
            // Move to the system month and reload events
            const sys = new Date();
            try {
                this.calendar?.gotoDate(new Date(sys.getFullYear(), sys.getMonth(), 1));
            } catch {}
            await this.loadSpecialDays(sys);
            this.calendar?.refetchEvents();
            this.scheduleMonthAutoAdvance();
        }, delay);
    }
}

// Global Functions
function showDayDetails(dayId) {
    const day = specialDaysManager.specialDays.find(d => d.id === dayId);
    if (day) {
        alert(`${day.name}\n\nDate: ${day.date}\nType: ${day.type}\nDescription: ${day.description}\n\nCampaign Message:\n${day.campaignMessage}`);
    }
}

function editSpecialDay(dayId) {
    const day = specialDaysManager.specialDays.find(d => d.id === dayId);
    if (day) {
        // Populate edit form with day data
        // For now, show a placeholder
        alert(`Edit ${day.name} - Feature coming soon!`);
    }
}

function createCampaign(dayId) {
    const day = specialDaysManager.specialDays.find(d => d.id === dayId);
    if (day) {
        if (confirm(`Create campaign for ${day.name}?`)) {
            alert(`Campaign created for ${day.name}!`);
        }
    }
}

function deleteSpecialDay(dayId) {
    const day = specialDaysManager.specialDays.find(d => d.id === dayId);
    if (day) {
        if (confirm(`Delete ${day.name}? This action cannot be undone.`)) {
            specialDaysManager.specialDays = specialDaysManager.specialDays.filter(d => d.id !== dayId);
            specialDaysManager.renderSpecialDaysList();
            specialDaysManager.calendar.refetchEvents();
            alert(`${day.name} deleted successfully!`);
        }
    }
}

function saveSpecialDay() {
    const form = document.getElementById('addSpecialDayForm');
    const formData = new FormData(form);
    
    // Basic validation
    const name = document.getElementById('eventName').value;
    const type = document.getElementById('eventType').value;
    const date = document.getElementById('eventDate').value;
    
    if (!name || !type || !date) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Create new special day object
    const newDay = {
        id: Date.now(), // Simple ID generation
        name: name,
        type: type,
        date: date,
        description: document.getElementById('eventDescription').value,
        isRecurring: document.getElementById('recurrencePattern').value !== 'none',
        targetAudience: Array.from(document.getElementById('targetAudience').selectedOptions).map(option => option.value),
        campaignMessage: document.getElementById('campaignMessage').value
    };
    
    // Add to special days array
    specialDaysManager.specialDays.push(newDay);
    specialDaysManager.renderSpecialDaysList();
    specialDaysManager.calendar.refetchEvents();
    
    // Close modal and reset form
    const modal = bootstrap.Modal.getInstance(document.getElementById('addSpecialDayModal'));
    modal.hide();
    form.reset();
    
    alert(`${name} added successfully!`);
}

// Initialize Special Days Manager
let specialDaysManager;
document.addEventListener('DOMContentLoaded', function() {
    specialDaysManager = new SpecialDaysManager();
});
</script>
{% endblock %}