{% extends 'adminSupport/base.html' %}

{% block title %}Chat System{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1>Chat System</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'adminSupport:support_dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item active">Chat System</li>
            </ol>
        </nav>
    </div>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newConversationModal">
            <i class="fas fa-plus me-2"></i>New Conversation
        </button>
    </div>
</div>

<!-- Chat Interface -->
<div class="row" style="height: calc(100vh - 250px);">
    <!-- Conversations List -->
    <div class="col-lg-4 pe-2">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Conversations</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadConversations()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newConversationModal">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Search Bar -->
                <div class="p-3 border-bottom">
                    <div class="input-group">
                        <input type="text" class="form-control" id="conversationSearch" placeholder="Search conversations...">
                        <button class="btn btn-outline-secondary" onclick="searchConversations()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="px-3 pt-2">
                    <ul class="nav nav-pills nav-fill nav-sm">
                        <li class="nav-item">
                            <a class="nav-link active small" href="#" data-filter="all" onclick="filterConversations('all')">All</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link small" href="#" data-filter="unread" onclick="filterConversations('unread')">Unread</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link small" href="#" data-filter="active" onclick="filterConversations('active')">Active</a>
                        </li>
                    </ul>
                </div>

                <!-- Conversations List -->
                <div id="conversationsList" class="overflow-auto" style="height: calc(100% - 140px);">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 small">Loading conversations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="col-lg-8 ps-2">
        <div class="card h-100">
            <!-- Chat Header -->
            <div class="card-header" id="chatHeader" style="display: none;">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; font-weight: bold;" id="chatUserAvatar">
                            U
                        </div>
                        <div>
                            <h6 class="mb-0" id="chatUserName">User Name</h6>
                            <small class="text-muted" id="chatUserStatus">Online</small>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="viewUserProfile()">
                            <i class="fas fa-user me-1"></i>Profile
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="closeChat()">
                            <i class="fas fa-times me-1"></i>Close
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="card-body p-0 d-flex flex-column">
                <!-- Welcome Message -->
                <div id="welcomeMessage" class="flex-grow-1 d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <h5>Welcome to Chat Support</h5>
                        <p class="text-muted">Select a conversation to start chatting or create a new one.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newConversationModal">
                            <i class="fas fa-plus me-2"></i>Start New Conversation
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-grow-1 p-3 overflow-auto" style="display: none; max-height: 400px; background-color: #f8f9fa;">
                    <!-- Messages will be loaded here -->
                </div>

                <!-- Message Input -->
                <div id="messageInput" class="p-3 border-top" style="display: none;">
                    <form id="sendMessageForm">
                        <div class="input-group">
                            <input type="text" class="form-control" name="message" placeholder="Type your message..." autocomplete="off">
                            <button type="button" class="btn btn-outline-secondary" onclick="showEmojiPicker()">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="attachFile()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Conversation Modal -->
<div class="modal fade" id="newConversationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start New Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newConversationForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select User</label>
                        <select class="form-select" name="user_id" required id="userSelect">
                            <option value="">Loading users...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial Message</label>
                        <textarea class="form-control" name="initial_message" rows="3" placeholder="Type your initial message..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Start Conversation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userProfileContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentConversationId = null;
let chatUpdateInterval = null;

$(document).ready(function() {
    loadConversations();
    loadUsers();
    
    // Auto-refresh conversations every 30 seconds
    setInterval(loadConversations, 30000);
});

function loadConversations() {
    $('#conversationsList').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 small">Loading conversations...</p>
        </div>
    `);
    
    $.get('{% url "adminSupport:api_conversation_list" %}', function(data) {
        displayConversations(data.results || []);
    }).fail(function() {
        // Show sample conversations
        const sampleConversations = [
            {
                id: 1,
                user: { name: "John Smith", role: "Client", avatar: "JS" },
                last_message: { content: "Hello, I need help with my property", timestamp: "2025-01-09T10:30:00Z" },
                unread_count: 2,
                status: "active",
                priority: "normal"
            },
            {
                id: 2,
                user: { name: "Sarah Johnson", role: "Marketer", avatar: "SJ" },
                last_message: { content: "Can we schedule a meeting?", timestamp: "2025-01-09T09:15:00Z" },
                unread_count: 0,
                status: "active",
                priority: "high"
            },
            {
                id: 3,
                user: { name: "Mike Davis", role: "Client", avatar: "MD" },
                last_message: { content: "Thank you for your help!", timestamp: "2025-01-08T16:45:00Z" },
                unread_count: 0,
                status: "closed",
                priority: "normal"
            }
        ];
        displayConversations(sampleConversations);
    });
}

function displayConversations(conversations) {
    let html = '';
    
    if (conversations.length === 0) {
        html = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                <p class="text-muted small">No conversations found</p>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newConversationModal">
                    Start Conversation
                </button>
            </div>
        `;
    } else {
        conversations.forEach(function(conv) {
            const isActive = conv.id === currentConversationId;
            const activeClass = isActive ? 'bg-primary bg-opacity-10 border-primary' : '';
            const unreadBadge = conv.unread_count > 0 ? `<span class="badge bg-primary rounded-pill">${conv.unread_count}</span>` : '';
            const priorityIcon = conv.priority === 'urgent' ? '<i class="fas fa-exclamation-triangle text-danger me-1"></i>' : conv.priority === 'high' ? '<i class="fas fa-exclamation text-warning me-1"></i>' : '';
            const timeAgo = formatTimeAgo(conv.last_message?.timestamp);
            
            html += `
                <div class="conversation-item p-3 border-bottom cursor-pointer ${activeClass}" onclick="openConversation(${conv.id})" data-conversation-id="${conv.id}">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px; font-size: 12px; font-weight: bold;">
                            ${conv.user.avatar || conv.user.name.split(' ').map(n => n[0]).join('')}
                        </div>
                        <div class="flex-grow-1 min-width-0">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0 small text-truncate">${priorityIcon}${conv.user.name}</h6>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">${timeAgo}</small>
                                    ${unreadBadge}
                                </div>
                            </div>
                            <p class="mb-0 small text-muted text-truncate">${conv.last_message?.content || 'No messages'}</p>
                            <small class="text-muted">${conv.user.role}</small>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    $('#conversationsList').html(html);
}

function openConversation(conversationId) {
    if (currentConversationId === conversationId) return;
    
    currentConversationId = conversationId;
    
    // Update active conversation in list
    $('.conversation-item').removeClass('bg-primary bg-opacity-10 border-primary');
    $(`.conversation-item[data-conversation-id="${conversationId}"]`).addClass('bg-primary bg-opacity-10 border-primary');
    
    // Show chat interface
    $('#welcomeMessage').hide();
    $('#chatHeader').show();
    $('#chatMessages').show();
    $('#messageInput').show();
    
    // Load conversation details
    loadConversationMessages(conversationId);
    
    // Start auto-refresh for messages
    if (chatUpdateInterval) clearInterval(chatUpdateInterval);
    chatUpdateInterval = setInterval(() => loadConversationMessages(conversationId), 5000);
}

function loadConversationMessages(conversationId) {
    // Update header with conversation info (simulate)
    $('#chatUserName').text('Loading...');
    $('#chatUserStatus').text('Loading...');
    
    $.get(`{% url "adminSupport:api_conversation_messages" conv_id=0 %}`.replace('0', conversationId), function(data) {
        displayMessages(data.messages || []);
        
        // Update header
        if (data.user) {
            $('#chatUserName').text(data.user.name);
            $('#chatUserStatus').text(data.user.is_online ? 'Online' : 'Offline');
            $('#chatUserAvatar').text(data.user.avatar || data.user.name.split(' ').map(n => n[0]).join(''));
        }
    }).fail(function() {
        // Show sample messages
        const sampleMessages = [
            {
                id: 1,
                content: "Hello, I need help with my property listing",
                is_support: false,
                timestamp: "2025-01-09T10:30:00Z",
                sender: { name: "John Smith" }
            },
            {
                id: 2,
                content: "Hi John! I'd be happy to help you with your property listing. What specific assistance do you need?",
                is_support: true,
                timestamp: "2025-01-09T10:32:00Z",
                sender: { name: "Support Team" }
            },
            {
                id: 3,
                content: "I'm having trouble uploading images for my property. The system keeps giving me an error.",
                is_support: false,
                timestamp: "2025-01-09T10:35:00Z",
                sender: { name: "John Smith" }
            }
        ];
        displayMessages(sampleMessages);
        
        // Update header with sample data
        $('#chatUserName').text('John Smith');
        $('#chatUserStatus').text('Online');
        $('#chatUserAvatar').text('JS');
    });
}

function displayMessages(messages) {
    let html = '';
    
    messages.forEach(function(msg) {
        const isSupport = msg.is_support;
        const alignClass = isSupport ? 'justify-content-end' : 'justify-content-start';
        const bgClass = isSupport ? 'bg-primary text-white' : 'bg-white';
        const timeAgo = formatTimeAgo(msg.timestamp);
        
        html += `
            <div class="d-flex ${alignClass} mb-3">
                <div class="max-width-70">
                    <div class="p-3 rounded ${bgClass}" style="max-width: 300px;">
                        <p class="mb-1">${msg.content}</p>
                        <small class="${isSupport ? 'text-white-50' : 'text-muted'}">${timeAgo}</small>
                    </div>
                    <small class="text-muted ${isSupport ? 'text-end d-block' : ''}">${msg.sender.name}</small>
                </div>
            </div>
        `;
    });
    
    $('#chatMessages').html(html);
    
    // Scroll to bottom
    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
}

function closeChat() {
    currentConversationId = null;
    
    if (chatUpdateInterval) {
        clearInterval(chatUpdateInterval);
        chatUpdateInterval = null;
    }
    
    $('#welcomeMessage').show();
    $('#chatHeader').hide();
    $('#chatMessages').hide();
    $('#messageInput').hide();
    
    // Remove active state from conversations
    $('.conversation-item').removeClass('bg-primary bg-opacity-10 border-primary');
}

function loadUsers() {
    $.get('{% url "adminSupport:api_users" %}', function(data) {
        let options = '<option value="">Select a user</option>';
        
        if (data.results && data.results.length > 0) {
            data.results.forEach(function(user) {
                options += `<option value="${user.id}">${user.name} (${user.role})</option>`;
            });
        } else {
            // Sample users
            const sampleUsers = [
                { id: 1, name: "Alice Cooper", role: "Client" },
                { id: 2, name: "Bob Wilson", role: "Marketer" },
                { id: 3, name: "Carol Brown", role: "Client" }
            ];
            sampleUsers.forEach(function(user) {
                options += `<option value="${user.id}">${user.name} (${user.role})</option>`;
            });
        }
        
        $('#userSelect').html(options);
    }).fail(function() {
        $('#userSelect').html('<option value="">Failed to load users</option>');
    });
}

function filterConversations(filter) {
    $('.nav-pills .nav-link').removeClass('active');
    $(`.nav-pills .nav-link[data-filter="${filter}"]`).addClass('active');
    
    // Implement filtering logic here
    console.log(`Filter conversations by: ${filter}`);
}

function searchConversations() {
    const query = $('#conversationSearch').val();
    console.log(`Search conversations: ${query}`);
    // Implement search logic here
}

function viewUserProfile() {
    $('#userProfileModal').modal('show');
    $('#userProfileContent').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `);
    
    // Simulate loading user profile
    setTimeout(function() {
        $('#userProfileContent').html(`
            <div class="text-center mb-4">
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px; font-size: 24px; font-weight: bold;">
                    JS
                </div>
                <h5>John Smith</h5>
                <span class="badge bg-success">Client</span>
            </div>
            <div class="row">
                <div class="col-6">
                    <strong>Email:</strong><br>
                    <span class="text-muted">john.smith@email.com</span>
                </div>
                <div class="col-6">
                    <strong>Phone:</strong><br>
                    <span class="text-muted">+1-234-567-8900</span>
                </div>
                <div class="col-6 mt-3">
                    <strong>Join Date:</strong><br>
                    <span class="text-muted">Jan 15, 2024</span>
                </div>
                <div class="col-6 mt-3">
                    <strong>Properties:</strong><br>
                    <span class="text-muted">3 active listings</span>
                </div>
            </div>
        `);
    }, 1000);
}

function showEmojiPicker() {
    alert('Emoji picker feature coming soon!');
}

function attachFile() {
    alert('File attachment feature coming soon!');
}

function formatTimeAgo(timestamp) {
    if (!timestamp) return '';
    
    const now = new Date();
    const time = new Date(timestamp);
    const diffMs = now - time;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
}

// Form submissions
$('#sendMessageForm').on('submit', function(e) {
    e.preventDefault();
    
    const message = $('input[name="message"]').val().trim();
    if (!message || !currentConversationId) return;
    
    // Send message
    $.post(`{% url "adminSupport:api_conversation_send_message" conv_id=0 %}`.replace('0', currentConversationId), {
        'csrfmiddlewaretoken': '{{ csrf_token }}',
        'message': message
    }, function(data) {
        $('input[name="message"]').val('');
        loadConversationMessages(currentConversationId);
        loadConversations(); // Update conversation list
    }).fail(function() {
        alert('Failed to send message');
    });
});

$('#newConversationForm').on('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    $.ajax({
        url: '{% url "adminSupport:api_conversation_create" %}',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            $('#newConversationModal').modal('hide');
            $('#newConversationForm')[0].reset();
            loadConversations();
            
            // Open the new conversation
            if (data.id) {
                setTimeout(() => openConversation(data.id), 500);
            }
        },
        error: function() {
            alert('Failed to create conversation');
        }
    });
});

// Keyboard shortcuts
$(document).on('keypress', 'input[name="message"]', function(e) {
    if (e.which === 13) { // Enter key
        $('#sendMessageForm').submit();
    }
});

// Cleanup on page unload
$(window).on('beforeunload', function() {
    if (chatUpdateInterval) {
        clearInterval(chatUpdateInterval);
    }
});
</script>

<style>
.cursor-pointer {
    cursor: pointer;
}

.max-width-70 {
    max-width: 70%;
}

.min-width-0 {
    min-width: 0;
}

.conversation-item:hover {
    background-color: rgba(0, 0, 0, 0.05) !important;
}

.conversation-item.bg-primary.bg-opacity-10:hover {
    background-color: rgba(37, 99, 235, 0.2) !important;
}

#chatMessages {
    background-image: 
        radial-gradient(circle at 25px 25px, rgba(255,255,255,0.2) 2%, transparent 0%), 
        radial-gradient(circle at 75px 75px, rgba(255,255,255,0.2) 2%, transparent 0%);
    background-size: 100px 100px;
}

.nav-pills .nav-link {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}
</style>
{% endblock %}