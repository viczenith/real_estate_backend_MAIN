{% extends 'client_base.html' %}
{% load static %}
{% block content %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Plot Allocation</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ home_url }}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'my-client-profile' %}">Property List</a></li>
        <li class="breadcrumb-item">Estate Details</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->
    <div class="container py-5">
      <!-- Estate Header -->
      <div class="card estate-header p-4 shadow-lg">
        <h1 class="fw-bold">{{ estate.name }}</h1>
        <p class="text-muted"><i class="bi bi-geo-alt"></i> {{ estate.location }}</p>
        <p><strong>Estate Size:</strong> {{ estate.estate_size }}</p>
        <p><strong>Title Deed:</strong> {{ estate.title_deed }}</p>
        <p><strong>Plot Size:</strong> <span class="badge text-bg-success">{{ plot_size.size }}</span></p>
          
        </p>
      </div>
      

      <!-- Estate Updates Section -->
      <div class="row mt-4">

      <!-- Estate Progress Status -->
      <div class="col-lg-6">
        <div class="card shadow p-3">
          <h4 class="fw-bold">Progress Status</h4>
          <ul class="list-group list-group-flush">
            {% for status in estate.progress_status.all %}
              <li class="list-group-item">
                <i class="bi bi-check-circle-fill text-success"></i>
                <strong>{{ status.timestamp|date:"d M, Y H:i" }}</strong>: {{ status.progress_status }}
              </li>
            {% empty %}
              <li class="list-group-item text-muted">No progress updates available.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Estate Amenities Section -->
      <div class="col-lg-6">
        <div class="card p-4 shadow mb-4">
          <h3 class="fw-bold mb-3">Estate Amenities</h3>
          {% if estate.estate_amenity.all %}
            {% for amenity_record in estate.estate_amenity.all %}
              {% with amenities_list=amenity_record.get_amenity_display %}
                {% if amenities_list %}
                  <ul class="list-group list-group-flush">
                    {% for display_name, icon_class in amenities_list %}
                      <li class="list-group-item">
                        <i class="{{ icon_class }}"></i> {{ display_name }}
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-muted">No amenities selected.</p>
                {% endif %}
              {% endwith %}
            {% endfor %}
          {% else %}
            <p class="text-muted">No amenities available for this estate.</p>
          {% endif %}

        </div>
      </div>


      <!-- Estate Prototypes Section -->
      <div class="card p-4 shadow mb-4">
        <h3 class="fw-bold mb-3">{{ plot_size.size }} Prototype</h3>
        {% if estate.prototypes.all %}
          <div class="row">
            {% for prototype in estate.prototypes.all %}
              {% if prototype.plot_size.id == plot_size.id %}
                <div class="col-md-4 mb-4">
                  <div class="card">
                    <div class="zoom-wrapper">
                      <div class="zoom-container">
                        <img src="{{ prototype.prototype_image.url }}" 
                            alt="Prototype Image" 
                            class="zoomable-img card-img-top img-fluid rounded shadow">
                      </div>
                      <div class="zoom-controls">
                        <button class="zoom-in btn btn-primary">+</button>
                        <button class="zoom-out btn btn-primary">–</button>
                      </div>
                    </div>
                    <div class="card-body">
                      <h5 class="card-title">{{ prototype.Title }}</h5>
                      <p class="card-text">{{ prototype.Description }}</p>
                      <p class="card-text">
                        <small class="text-muted">{{ prototype.date_uploaded|date:"d M, Y" }}</small>
                      </p>
                     
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">No prototypes available for {{ plot_size.size }} SQM plots in this estate.</p>
        {% endif %}
      </div>


      <!-- Zoomable Estate Layout -->
      <div class="row mb-4 mt-4">
        <div class="col-lg-12">
          <div class="card p-4 shadow">
            <h4 class="fw-bold mb-3">Estate Layout</h4>
            {% if estate.estate_layout.all %}
              {% for layout in estate.estate_layout.all %}
                <div class="zoom-wrapper">
                  <div class="zoom-container">
                    <img src="{{ layout.layout_image.url }}" alt="Estate Layout" class="zoomable-img img-fluid rounded shadow">
                  </div>
                  <div class="zoom-controls">
                    <button class="zoom-in btn btn-primary">+</button>
                    <button class="zoom-out btn btn-primary">–</button>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p>No estate layouts available.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Estate Floor Plans Section -->
      <div class="card p-4 shadow mb-4">
        <h4 class="fw-bold mb-3">{{ plot_size.size }} Building Plans</h4>
        <div class="row">
          {% if floor_plans %}
            {% for plan in floor_plans %}
              <div class="col-lg-12 mb-4">
                <div class="card p-4 shadow">
                  <div class="zoom-wrapper">
                    <div class="zoom-container">
                      <img src="{{ plan.floor_plan_image.url }}" 
                          alt="Floor Plan" 
                          class="zoomable-img img-fluid rounded shadow">
                    </div>
                    <div class="zoom-controls">
                      <button class="zoom-in btn btn-primary">+</button>
                      <button class="zoom-out btn btn-primary">–</button>
                    </div>
                  </div>
                  <h5 class="mt-2">
                    <small>{{ forloop.counter }}: {{ plan.plan_title }}</small>
                  </h5>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="col-12">
              <div class="alert alert-info">
                No floor plans available for {{ plot_size.size }} SQM plots in this estate
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Google Map Integration -->
      <!-- <div class="card mt-4 p-4 shadow">
        <h4 class="fw-bold">Estate Location</h4>
        <div id="google-map" class="rounded shadow" style="height: 350px;"></div>
      </div> -->

          <!-- Estate Location Section -->
    <div class="card p-4 shadow mb-4">
      <h4 class="fw-bold">Estate Location</h4>
      <div id="map-container" class="map-container" style="height: 350px;">
        {% if estate.map.all %}
          {% with map_obj=estate.map.first %}
            {% if map_obj.generate_google_map_link %}
              <!-- Embedded Map -->
              <iframe 
                src="{{ map_obj.generate_google_map_link }}"
                width="100%" 
                height="350" 
                style="border:0;" 
                allowfullscreen="" 
                loading="lazy">
              </iframe>
              <!-- Centered clickable button overlay -->
              <a href="{{ map_obj.generate_google_map_link|cut:'&output=embed' }}" target="_blank" class="map-link-button">
                View on Google Maps
              </a>
            {% else %}
              <p>No map available.</p>
            {% endif %}
          {% endwith %}
        {% else %}
          <p>No map available.</p>
        {% endif %}
      </div>
    </div>

    <style>
      .map-container {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      .map-container iframe {
        display: block;
      }
      .map-link-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.7);
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        opacity: 0.9;
      }
      .map-link-button:hover {
        background: rgba(0,0,0,0.9);
      }
    </style>


      <!-- Back Button -->
      <div class="mt-4 text-center">
        <a href="{% url 'my-client-profile' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to Property List
        </a>
      </div>
    </div>

  
    
    <!-- Google Maps API -->
    <script>
      function initMap() {
        var estateLocation = { lat: {{ estate.latitude }}, lng: {{ estate.longitude }} };
        var map = new google.maps.Map(document.getElementById("google-map"), {
          zoom: 15,
          center: estateLocation,
        });
        new google.maps.Marker({
          position: estateLocation,
          map: map,
          title: "{{ estate.name }}"
        });
      }
    </script>


<style>
  .zoom-wrapper {
    position: relative;
    display: inline-block;
  }
  .zoom-container {
    overflow: auto;
    border-radius: 12px;
  }
  .zoom-container img {
    transition: transform 0.3s ease;
    width: 100%;
  }
  .zoom-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 10;
  }
  .zoom-controls button {
    width: 40px;
    height: 40px;
    font-size: 24px;
    line-height: 24px;
    padding: 0;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    cursor: pointer;
  }
  .zoom-controls button:hover {
    background: rgba(0, 0, 0, 0.7);
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.zoom-wrapper').forEach(function(wrapper) {
      let scale = 1;
      const zoomInBtn = wrapper.querySelector('.zoom-in');
      const zoomOutBtn = wrapper.querySelector('.zoom-out');
      const img = wrapper.querySelector('.zoomable-img');
      
      // Make sure all elements exist before adding event listeners
      if (zoomInBtn && zoomOutBtn && img) {
        zoomInBtn.addEventListener("click", function() {
          scale += 0.2;
          img.style.transform = `scale(${scale})`;
        });

        zoomOutBtn.addEventListener("click", function() {
          if (scale > 0.4) {
            scale -= 0.2;
            img.style.transform = `scale(${scale})`;
          }
        });
      }
    });
  });
</script>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap" async defer></script>

</main>
{% endblock %}
