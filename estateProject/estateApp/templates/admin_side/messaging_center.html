{% extends "admin_base.html" %}
{% load static %}
{% block content %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Messaging Center</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ home_url }}">Home</a></li>
        <li class="breadcrumb-item active">Bulk Messaging</li>
      </ol>
    </nav>
  </div>

  <style>
  :root {
    --bg: #f6f8fb;
    --card: #ffffff;
    --muted: #7b8794;
    --accent: #0b6efd;
    --accent-2: #0f9d58;
    --danger: #e03131;
    --radius: 14px;
    --shadow: 0 8px 30px rgba(15,23,42,0.06);
  }
  
  .main {
    padding: 28px;
    min-height: 80vh;
    background: linear-gradient(180deg, var(--bg), #fff);
  }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 22px;
    flex-wrap: wrap;
  }
  
  .header-left h1 {
    font-size: 26px;
    margin: 0;
    font-weight: 700;
    color: #1e293b;
  }
  
  .header-left p {
    color: var(--muted);
    margin: 4px 0 0;
    font-size: 14px;
    max-width: 600px;
  }
  
  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(11,110,253,0.02);
    margin-bottom: 20px;
  }
  
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  
  .template-card, .campaign-card {
    padding: 16px;
    border-radius: 12px;
    border: 1px solid rgba(11,110,253,0.04);
    margin-bottom: 12px;
    background: #fff;
    transition: transform 0.2s ease;
  }
  
  .template-card:hover, .campaign-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(11,110,253,0.08);
  }
  
  .status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .status-scheduled { background: #e0f2fe; color: #0369a1; }
  .status-processing { background: #fffbeb; color: #b45309; }
  .status-completed { background: #dcfce7; color: #15803d; }
  
  .form-group {
    margin-bottom: 16px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #1e293b;
  }
  
  input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid rgba(11,110,253,0.1);
    background: #fff;
    font-size: 14px;
  }
  
  .channel-selector {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .channel-option {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: 1px solid rgba(11,110,253,0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .channel-option.selected {
    background: rgba(11,110,253,0.05);
    border-color: var(--accent);
  }
  
  .action-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  
  .btn {
    background: #fff;
    border: 1px solid rgba(20,30,60,0.06);
    color: #111827;
    padding: 10px 16px;
    border-radius: 10px;
    box-shadow: var(--shadow);
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(11,110,253,0.12);
  }
  
  .btn.primary {
    background: linear-gradient(90deg, var(--accent), #2b7bf6);
    color: #fff;
    border: none;
    box-shadow: 0 6px 18px rgba(11,110,253,0.15);
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
  }
  
  .stat-card {
    background: #f8fafc;
    border-radius: 12px;
    padding: 16px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent);
    margin: 8px 0 4px;
  }
  
  .stat-label {
    font-size: 14px;
    color: var(--muted);
  }
  
  @media (max-width: 992px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
  </style>

  <div class="main">
    <div class="header">
      <div class="header-left">
        <h1>Bulk Messaging Center</h1>
        <p class="small">Send seasonal, promotional, and announcement messages to clients and marketers.</p>
      </div>
      <div class="header-actions">
        <button class="btn primary" id="create-bulk-template"><i class="ri-file-text-line"></i> New Template</button>
        <button class="btn primary" id="schedule-bulk-campaign"><i class="ri-send-plane-line"></i> Schedule Campaign</button>
      </div>
    </div>

    <div class="grid">
      <!-- Templates Section -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2 style="font-size:20px;font-weight:700">Message Templates</h2>
          <div class="small" style="color:var(--muted)">{{ templates|length }} templates</div>
        </div>
        
        <div class="templates-list">
          {% for template in templates %}
          <div class="template-card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:15px">
              <div style="flex:1">
                <div style="font-weight:700;font-size:16px">{{ template.name }}</div>
                <div style="display:flex;gap:10px;margin-top:8px">
                  <div class="small" style="background:#eef2ff;color:#4f46e5;padding:4px 10px;border-radius:6px">
                    {{ template.get_category_display }}
                  </div>
                  <div class="small" style="background:#f0fdf4;color:#16a34a;padding:4px 10px;border-radius:6px">
                    {{ template.get_audience_display }}
                  </div>
                </div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn" data-action="edit-template" data-id="{{ template.id }}">Edit</button>
                <button class="btn primary" data-action="use-template" data-id="{{ template.id }}">Use</button>
              </div>
            </div>
          </div>
          {% empty %}
          <div style="text-align:center;padding:40px 20px">
            <i class="ri-file-text-line" style="font-size:48px;color:rgba(11,110,253,0.2);margin-bottom:15px"></i>
            <p style="color:var(--muted)">No templates created yet</p>
          </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- Campaigns Section -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2 style="font-size:20px;font-weight:700">Scheduled Campaigns</h2>
          <div class="small" style="color:var(--muted)">{{ campaigns|length }} campaigns</div>
        </div>
        
        <div class="campaigns-list">
          {% for campaign in campaigns %}
          <div class="campaign-card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:15px">
              <div style="flex:1">
                <div style="font-weight:700;font-size:16px">{{ campaign.name }}</div>
                <div style="display:flex;align-items:center;gap:10px;margin-top:8px">
                  <span class="status-badge status-{{ campaign.status }}">{{ campaign.get_status_display }}</span>
                  <div class="small" style="color:var(--muted)">
                    {{ campaign.scheduled_time|date:"M d, Y H:i" }}
                  </div>
                </div>
              </div>
              <div>
                <button class="btn" data-action="view-campaign" data-id="{{ campaign.id }}">View</button>
              </div>
            </div>
            
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Recipients</div>
                <div class="stat-value">{{ campaign.total_recipients }}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Sent</div>
                <div class="stat-value">{{ campaign.total_sent }}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Failed</div>
                <div class="stat-value">{{ campaign.total_recipients|add:"-campaign.total_sent" }}</div>
              </div>
            </div>
          </div>
          {% empty %}
          <div style="text-align:center;padding:40px 20px">
            <i class="ri-send-plane-line" style="font-size:48px;color:rgba(11,110,253,0.2);margin-bottom:15px"></i>
            <p style="color:var(--muted)">No campaigns scheduled yet</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- New Template Modal -->
    <div class="modal-backdrop" id="template-modal" style="display:none">
      <div class="modal-dialog">
        <h3>Create New Template</h3>
        <form id="template-form">
          {% csrf_token %}
          <div class="form-group">
            <label>Template Name</label>
            <input type="text" name="name" required>
          </div>
          
          <div class="form-group">
            <label>Category</label>
            <select name="category" required>
              {% for value, label in categories %}
                <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label>Audience</label>
            <select name="audience" required>
              {% for value, label in audiences %}
                <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label>Channels</label>
            <div class="channel-selector">
              <label class="channel-option">
                <input type="checkbox" name="channels" value="in_app" checked>
                <span>In-App</span>
              </label>
              <label class="channel-option">
                <input type="checkbox" name="channels" value="email">
                <span>Email</span>
              </label>
              <label class="channel-option">
                <input type="checkbox" name="channels" value="sms">
                <span>SMS</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label>Message Content</label>
            <textarea name="body" rows="8" required></textarea>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn" id="cancel-template">Cancel</button>
            <button type="submit" class="btn primary">Save Template</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Schedule Campaign Modal -->
    <div class="modal-backdrop" id="campaign-modal" style="display:none">
      <div class="modal-dialog">
        <h3>Schedule New Campaign</h3>
        <form id="campaign-form">
          {% csrf_token %}
          <div class="form-group">
            <label>Campaign Name</label>
            <input type="text" name="name" required>
          </div>
          
          <div class="form-group">
            <label>Select Template</label>
            <select name="template_id" required>
              {% for template in templates %}
                <option value="{{ template.id }}">{{ template.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label>Scheduled Time</label>
            <input type="datetime-local" name="scheduled_time" required>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn" id="cancel-campaign">Cancel</button>
            <button type="submit" class="btn primary">Schedule Campaign</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  const csrf = '{{ csrf_token }}';
  
  // Template modal
  $('#create-bulk-template').addEventListener('click', () => {
    $('#template-modal').style.display = 'flex';
  });
  
  $('#cancel-template').addEventListener('click', () => {
    $('#template-modal').style.display = 'none';
  });
  
  // Campaign modal
  $('#schedule-bulk-campaign').addEventListener('click', () => {
    if ({{ templates|length }} === 0) {
      alert('Please create a template first');
      return;
    }
    $('#campaign-modal').style.display = 'flex';
  });
  
  $('#cancel-campaign').addEventListener('click', () => {
    $('#campaign-modal').style.display = 'none';
  });
  
  // Channel selection
  $all('.channel-option').forEach(option => {
    option.addEventListener('click', () => {
      const checkbox = option.querySelector('input');
      checkbox.checked = !checkbox.checked;
      option.classList.toggle('selected', checkbox.checked);
    });
  });
  
  // Save template
  $('#template-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    try {
      const response = await fetch("{% url 'api_create_bulk_template' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrf},
        body: formData
      });
      
      const data = await response.json();
      if (data.status === 'success') {
        alert('Template created successfully');
        location.reload();
      } else {
        alert(`Error: ${data.message}`);
      }
    } catch (error) {
      alert('Error creating template');
    }
  });
  
  // Schedule campaign
  $('#campaign-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    try {
      const response = await fetch("{% url 'api_schedule_bulk_campaign' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrf},
        body: formData
      });
      
      const data = await response.json();
      if (data.status === 'success') {
        alert('Campaign scheduled successfully');
        location.reload();
      } else {
        alert(`Error: ${data.message}`);
      }
    } catch (error) {
      alert('Error scheduling campaign');
    }
  });
  
  // Use template
  $all('[data-action="use-template"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const templateId = btn.dataset.id;
      $('#campaign-form select[name="template_id"]').value = templateId;
      $('#campaign-modal').style.display = 'flex';
    });
  });
  
  // View campaign
  $all('[data-action="view-campaign"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const campaignId = btn.dataset.id;
      window.location.href = `/admin/messaging/campaigns/${campaignId}/`;
    });
  });
  </script>
</main>
{% endblock %}