{% extends "admin_base.html" %}
{% load static %}
{% block content %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Profile</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ home_url }}">Home</a></li>
        <li class="breadcrumb-item active">Birthday Center </li>
      </ol>
    </nav>
  </div><!-- End Page Title -->

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
  :root {
    --bg: #f6f8fb;
    --card: #ffffff;
    --muted: #7b8794;
    --accent: #0b6efd;
    --accent-2: #0f9d58;
    --danger: #e03131;
    --glass: rgba(255,255,255,0.7);
    --radius: 14px;
    --shadow: 0 8px 30px rgba(15,23,42,0.06);
    --glass-border: 1px solid rgba(11,110,253,0.06);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }
  
  .main {
    padding: 28px;
    min-height: 80vh;
    background: linear-gradient(180deg, var(--bg), #fff);
  }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 22px;
    flex-wrap: wrap;
  }
  
  .header-left h1 {
    font-size: 26px;
    margin: 0;
    font-weight: 700;
    color: #1e293b;
  }
  
  .header-left p {
    color: var(--muted);
    margin: 4px 0 0;
    font-size: 14px;
    max-width: 600px;
  }
  
  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .btn {
    background: var(--card);
    border: 1px solid rgba(20,30,60,0.06);
    color: #111827;
    padding: 10px 16px;
    border-radius: 10px;
    box-shadow: var(--shadow);
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(11,110,253,0.12);
  }
  
  .btn.primary {
    background: linear-gradient(90deg, var(--accent), #2b7bf6);
    color: #fff;
    border: none;
    box-shadow: 0 6px 18px rgba(11,110,253,0.15);
  }
  
  .btn.ghost {
    background: transparent;
    border: 1px dashed rgba(11,110,253,0.08);
    color: var(--accent);
  }
  
  .btn.ghost:hover {
    background: rgba(11,110,253,0.05);
  }
  
  .grid {
    display: grid;
    grid-template-columns: 360px 1fr 360px;
    gap: 18px;
    align-items: start;
  }
  
  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(11,110,253,0.02);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card:hover {
    box-shadow: 0 12px 40px rgba(15,23,42,0.08);
  }
  
  .today-hero {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  .avatar {
    width: 64px;
    height: 64px;
    border-radius: 12px;
    overflow: hidden;
    background: linear-gradient(135deg, #eef5ff, #f8fbff);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: var(--accent);
    flex-shrink: 0;
  }
  
  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .small {
    font-size: 13px;
    color: var(--muted);
  }
  
  .kpi {
    display: flex;
    gap: 10px;
    margin-top: 12px;
  }
  
  .kpi .item {
    background: linear-gradient(180deg, #fff, #fbfdff);
    padding: 14px 10px;
    border-radius: 10px;
    flex: 1;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
  }
  
  .kpi .value {
    font-weight: 700;
    font-size: 18px;
    color: #1e293b;
  }
  
  .toggle-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 14px;
  }
  
  .switch {
    position: relative;
    width: 46px;
    height: 28px;
    background: #e9eef9;
    border-radius: 999px;
    cursor: pointer;
    display: inline-block;
    transition: background 0.2s ease;
  }
  
  .switch .knob {
    position: absolute;
    left: 4px;
    top: 4px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    transition: all 0.18s cubic-bezier(.2,.9,.3,1);
    box-shadow: 0 4px 10px rgba(17,24,39,0.06);
  }
  
  .switch.on {
    background: linear-gradient(90deg, var(--accent), #2b7bf6);
  }
  
  .switch.on .knob {
    transform: translateX(18px);
  }
  
  .center-area .panel {
    margin-bottom: 14px;
  }
  
  .calendar-compact {
    background: linear-gradient(180deg, #ffffff, #fbfdff);
    padding: 16px;
    border-radius: 12px;
    display: flex;
    gap: 10px;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
  }
  
  .upcoming-list {
    max-height: 400px;
    overflow: auto;
    padding-right: 6px;
  }
  
  .up-item {
    display: flex;
    gap: 12px;
    padding: 14px;
    border-radius: 10px;
    align-items: center;
    border: 1px solid rgba(11,110,253,0.03);
    margin-bottom: 8px;
    background: #fbfdff;
    transition: transform 0.2s ease;
  }
  
  .up-item:hover {
    transform: translateX(4px);
    background: #f0f7ff;
  }
  
  .up-item .meta {
    font-size: 13px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  .tag {
    padding: 6px 10px;
    border-radius: 8px;
    background: rgba(11,110,253,0.06);
    color: var(--accent);
    font-weight: 700;
    font-size: 12px;
    display: inline-block;
  }
  
  .templates-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .template-card {
    padding: 14px;
    border-radius: 10px;
    border: 1px solid rgba(11,110,253,0.04);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    transition: transform 0.2s ease;
  }
  
  .template-card:hover {
    transform: translateY(-2px);
    border-color: rgba(11,110,253,0.1);
  }
  
  .template-meta {
    font-size: 13px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
  }
  
  .modal-dialog {
    width: 900px;
    max-width: 90vw;
    background: var(--card);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    animation: modalIn 0.3s ease-out;
  }
  
  @keyframes modalIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .modal-dialog h3 {
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 16px;
  }
  
  input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid rgba(11,110,253,0.1);
    background: #fff;
    font-size: 14px;
    transition: border-color 0.2s ease;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(11,110,253,0.1);
  }
  
  .action-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  
  .empty-state {
    text-align: center;
    padding: 30px 20px;
    border-radius: 12px;
    background: #f8fafc;
    border: 1px dashed rgba(11,110,253,0.1);
  }
  
  .empty-state i {
    font-size: 36px;
    color: rgba(11,110,253,0.3);
    margin-bottom: 10px;
  }
  
  .empty-state p {
    color: var(--muted);
    margin: 10px 0 0;
  }
  
  .chart-container {
    margin-top: 20px;
  }
  
  hr.divider {
    border: none;
    border-top: 1px solid rgba(11,110,253,0.04);
    margin: 16px 0;
  }
  
  /* Responsive styles */
  @media (max-width: 1200px) {
    .grid {
      grid-template-columns: 1fr 1fr;
    }
    .right-col {
      grid-column: span 2;
    }
  }
  
  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
    .right-col {
      grid-column: auto;
    }
    .header {
      flex-direction: column;
    }
    .header-actions {
      margin-top: 15px;
      width: 100%;
    }
    #global-tz {
      flex-grow: 1;
    }
  }
  
  @media (max-width: 480px) {
    .main {
      padding: 16px;
    }
    .kpi {
      flex-direction: column;
    }
    .up-item {
      flex-direction: column;
      align-items: flex-start;
    }
    .up-item > div:last-child {
      align-self: flex-end;
      margin-top: 10px;
    }
  }
  </style>

  <div class="main">
    <div class="header">
      <div class="header-left">
        <h1>Birthday Celebration Center</h1>
        <p class="small">Automated birthday wishes — targeted to Clients & Marketers. Set templates, schedules, preview and monitor performance (bank-grade experience).</p>
      </div>
      <div class="header-actions">
        <div class="small text-muted">Timezone</div>
        <select id="global-tz" class="btn" style="min-width:180px">
          {% for tz in timezones %}
            <option value="{{ tz }}" {% if tz == 'Africa/Lagos' %}selected{% endif %}>{{ tz }}</option>
          {% endfor %}
        </select>
        <button class="btn ghost" id="audit-export"><i class="ri-file-download-line"></i> Export Logs</button>
        <button class="btn primary" id="open-new-template"><i class="ri-star-line"></i> New Birthday Template</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Today's Celebrants & Controls -->
      <div class="left-col">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">Today</div>
              <div style="display:flex;align-items:center;gap:12px">
                <div style="font-weight:800;font-size:20px">Celebrants</div>
                <div class="tag">{{ today_birthdays|length }} today</div>
              </div>
              <div class="small" style="margin-top:6px;color:var(--muted)">Local time: <strong id="local-time"></strong></div>
            </div>
            <div style="text-align:right">
              <div class="small">Auto-send</div>
              <div class="toggle-row">
                <div id="autosend-switch" class="switch on"><div class="knob"></div></div>
                <div class="small" style="margin-left:6px;color:var(--muted)"><strong id="autosend-label">Enabled</strong></div>
              </div>
              <div style="margin-top:8px;font-size:12px;color:var(--muted)">Send window: <strong id="send-window">09:00 — 18:00</strong></div>
            </div>
          </div>

          <hr class="divider">

          <div>
            <!-- Carousel of today births -->
            <div id="today-carousel" style="display:flex;flex-direction:column;gap:8px">
              {% if today_birthdays %}
                {% for u in today_birthdays %}
                <div class="up-item" data-id="{{ u.id }}">
                  <div style="display:flex;gap:10px;align-items:center">
                    <div class="avatar">
                      {% if u.profile_image %}
                        <img src="{{ u.profile_image }}" alt="{{ u.full_name }}">
                      {% else %}
                        {{ u.full_name|first|upper }}
                      {% endif %}
                    </div>
                    <div>
                      <div style="font-weight:700">{{ u.full_name }}</div>
                      <div class="meta">{{ u.preferred_channel|default:"In-App" }} • {{ u.age }} yrs</div>
                    </div>
                  </div>
                  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                    <button class="btn" data-action="preview" data-user="{{ u.id }}">Preview</button>
                    <div style="display:flex;gap:6px">
                      <button class="btn ghost" data-action="queue" data-user="{{ u.id }}"><i class="ri-time-line"></i> Queue</button>
                      <button class="btn primary" data-action="send" data-user="{{ u.id }}"><i class="ri-send-plane-line"></i> Send Now</button>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="empty-state">
                  <i class="ri-cake-line"></i>
                  <div style="font-weight:600">No birthdays today</div>
                  <p>View upcoming birthdays below</p>
                </div>
              {% endif %}
            </div>
          </div>

          <hr class="divider">

          <div>
            <div class="small" style="margin-bottom:8px">Quick actions</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="open-segmentation"><i class="ri-stack-line"></i> Segments</button>
              <button class="btn" id="open-coupons"><i class="ri-discount-line"></i> Coupon Generator</button>
              <button class="btn" id="open-settings"><i class="ri-settings-3-line"></i> Settings</button>
            </div>
          </div>
        </div>

        <!-- Audit log preview -->
        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Recent Birthday Logs</div>
              <div class="small" style="color:var(--muted)">Last 7 days</div>
            </div>
            <div>
              <button class="btn ghost" id="view-all-logs">View All</button>
            </div>
          </div>
          <div style="margin-top:12px;max-height:220px;overflow:auto">
            {% if recent_logs %}
              {% for log in recent_logs %}
                <div style="display:flex;justify-content:space-between;gap:12px;padding:10px;border-radius:10px;margin-bottom:6px;border:1px solid rgba(11,110,253,0.03);background:#fbfdff">
                  <div>
                    <div style="font-weight:700">{{ log.user_full_name|default:"System" }}</div>
                    <div class="small" style="color:var(--muted)">{{ log.action }} • {{ log.created_at }}</div>
                  </div>
                  <div class="small" style="color:{{ log.color }};font-weight:500">
                    {{ log.status }}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state" style="padding:20px">
                <i class="ri-file-list-line"></i>
                <p>No logs available</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- CENTER: Calendar / Upcoming / Campaign Summary -->
      <div class="center-area">
        <div class="panel card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Upcoming Birthdays — 30 days</div>
              <div class="small" style="color:var(--muted)">Plan ahead and set offers / coupons</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="date" id="calendar-from" class="btn" value="{{ today|date:'Y-m-d' }}" style="padding:10px;border-radius:8px">
              <button class="btn ghost" id="refresh-upcoming"><i class="ri-refresh-line"></i></button>
            </div>
          </div>

          <div style="display:flex;gap:14px;margin-top:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:300px">
              <div class="calendar-compact">
                <div style="flex:1">
                  <div style="font-weight:700">{{ today|date:'F Y' }}</div>
                  <div class="small" style="color:var(--muted);margin-top:6px">Tap a date to see celebrants</div>
                </div>
                <div style="min-width:120px;text-align:center">
                  <div style="font-weight:800;font-size:22px">{{ today|date:'d' }}</div>
                  <div class="small" style="color:var(--muted)">{{ today|date:'l' }}</div>
                </div>
              </div>

              <div style="margin-top:12px" class="upcoming-list" id="upcoming-list">
                {% if upcoming_birthdays %}
                  {% for day in upcoming_birthdays %}
                    <div style="margin-bottom:8px">
                      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div style="font-weight:700">{{ day.date|date:'D, M d' }}</div>
                        <div class="small" style="color:var(--muted)">{{ day.users|length }} people</div>
                      </div>
                      {% for u in day.users %}
                        <div class="up-item" data-user="{{ u.id }}">
                          <div style="display:flex;gap:12px;align-items:center">
                            <div style="width:44px;height:44px;border-radius:10px;background:#f1f6ff;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)">
                              {% if u.profile_image %}
                                <img src="{{ u.profile_image }}" style="width:100%;height:100%;object-fit:cover;border-radius:8px" />
                              {% else %}
                                {{ u.full_name|first|upper }}
                              {% endif %}
                            </div>
                            <div>
                              <div style="font-weight:700">{{ u.full_name }}</div>
                              <div class="meta">{{ u.preferred_channel|default:"In-App" }} • {{ u.age }} yrs</div>
                            </div>
                          </div>
                          <div style="display:flex;gap:8px;align-items:center">
                            <button class="btn" data-action="preview" data-user="{{ u.id }}">Preview</button>
                            <button class="btn primary" data-action="schedule" data-user="{{ u.id }}" data-date="{{ day.date }}">Schedule</button>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="empty-state">
                    <i class="ri-calendar-line"></i>
                    <div style="font-weight:600">No upcoming birthdays</div>
                    <p>No birthdays in the next 30 days</p>
                  </div>
                {% endif %}
              </div>
            </div>

            <div style="width:360px;min-width:300px">
              <div class="card template-summary" style="padding:16px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <div style="font-weight:800">Templates</div>
                    <div class="small" style="color:var(--muted)">Active templates for birthday wishes</div>
                  </div>
                  <div>
                    <button class="btn ghost" id="manage-templates">Manage</button>
                  </div>
                </div>
                <div class="templates-list" style="margin-top:12px">
                  {% if templates %}
                    {% for tpl in templates|slice:":5" %}
                      <div class="template-card">
                        <div>
                          <div style="font-weight:700">{{ tpl.name }}</div>
                          <div class="template-meta">{{ tpl.audience|capfirst }} • {{ tpl.channel|upper }} • {{ tpl.send_time_local|default:"Anytime" }}</div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                          <div class="small" style="color:{{ tpl.is_active|yesno:'#0f9d58,#d1d5db' }}">{{ tpl.is_active|yesno:'Active,Disabled' }}</div>
                          <div style="display:flex;gap:6px">
                            <button class="btn" data-action="tpl-preview" data-id="{{ tpl.id }}">Preview</button>
                            <button class="btn primary" data-action="tpl-edit" data-id="{{ tpl.id }}">Edit</button>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="empty-state" style="padding:20px">
                      <i class="ri-file-text-line"></i>
                      <p>No templates created yet</p>
                    </div>
                  {% endif %}
                </div>
                <div style="margin-top:12px;text-align:center">
                  <button class="btn primary" id="open-templates-page">Open Template Library</button>
                </div>
              </div>

              <div class="card" style="margin-top:12px;padding:16px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <div style="font-weight:800">Campaign Performance</div>
                    <div class="small" style="color:var(--muted)">Last 30 days — Birthday messages</div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-weight:800;font-size:18px">{{ stats.sent|default:0 }}</div>
                    <div class="small" style="color:var(--muted)">Total Sent</div>
                  </div>
                </div>

                <div id="perf-chart" class="chart-container" style="height:160px"></div>

                <div style="display:flex;gap:12px;margin-top:12px">
                  <div style="flex:1;background:#fbfffb;border-radius:8px;padding:12px;text-align:center">
                    <div class="small" style="color:var(--muted)">Delivered</div>
                    <div style="font-weight:800">{{ stats.delivered|default:0 }}</div>
                  </div>
                  <div style="flex:1;background:#fff9f7;border-radius:8px;padding:12px;text-align:center">
                    <div class="small" style="color:var(--muted)">Opens</div>
                    <div style="font-weight:800">{{ stats.opens|default:0 }}</div>
                  </div>
                  <div style="flex:1;background:#f7fbff;border-radius:8px;padding:12px;text-align:center">
                    <div class="small" style="color:var(--muted)">Redemptions</div>
                    <div style="font-weight:800">{{ stats.redemptions|default:0 }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Campaign scheduling / advanced settings -->
        <div class="panel card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Auto-Wish Rules</div>
              <div class="small" style="color:var(--muted)">Configure recurrence, DND window, leap-year rule and fallbacks</div>
            </div>
            <div><button class="btn ghost" id="open-rules">Edit Rules</button></div>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:250px">
              <div style="display:flex;gap:12px;align-items:center">
                <div style="width:44px;height:44px;border-radius:10px;background:#f1f6ff;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800;flex-shrink:0">F</div>
                <div>
                  <div style="font-weight:700">Leap year handling</div>
                  <div class="small" style="color:var(--muted)">Send on Feb 28 (default). Change to Mar 1 if preferred.</div>
                </div>
              </div>
            </div>
            <div style="width:220px">
              <div class="small" style="color:var(--muted)">Fallback channel</div>
              <select id="fallback-channel" class="btn" style="width:100%;margin-top:6px">
                <option value="none">None (do not fallback)</option>
                <option value="email">Email</option>
                <option value="sms">SMS</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: quick templates + actions -->
      <div class="right-col">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Create Quick Template</div>
              <div class="small" style="color:var(--muted)">Create and send test in seconds</div>
            </div>
            <div><button class="btn ghost" id="open-quick-modal">Quick</button></div>
          </div>

          <form id="quick-form" style="margin-top:12px;display:flex;flex-direction:column;gap:12px">
            {% csrf_token %}
            <input type="text" name="name" placeholder="Title (e.g., Happy Birthday VIP)" class="btn" required>
            <select name="audience" class="btn">
              <option value="client">Clients</option>
              <option value="marketer">Marketers</option>
              <option value="both">Both</option>
            </select>
            <select name="channel" class="btn">
              <option value="in_app">In-App</option>
              <option value="email">Email</option>
              <option value="sms">SMS</option>
            </select>
            <textarea name="body" placeholder="Message body — use {{ first_name }}" class="btn" style="height:120px;resize:vertical" required></textarea>
            <div style="display:flex;gap:8px">
              <button type="button" class="btn ghost" id="preview-quick">Preview</button>
              <button type="submit" class="btn primary">Create & Save</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:800">Advanced Controls</div>
          <div class="small" style="color:var(--muted);margin-top:8px">Rate limit, retries & logs</div>
          <div style="margin-top:12px;display:flex;flex-direction:column;gap:12px">
            <div>
              <label class="small" style="display:block;margin-bottom:6px">Max sends / minute</label>
              <input id="rate-limit" class="btn" value="30" type="number" min="1" max="100">
            </div>
            <div>
              <label class="small" style="display:block;margin-bottom:6px">Retries (on failure)</label>
              <input id="retries" class="btn" value="3" type="number" min="0" max="5">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS: Template editor (rich), Preview, Schedule -->
  <div id="modal-root" style="display:none">
    <div class="modal-backdrop" id="tpl-modal">
      <div class="modal-dialog" role="dialog" aria-modal="true">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3>Create Birthday Template</h3>
          <div><button class="btn" id="tpl-close">Close</button></div>
        </div>

        <form id="tpl-form">
          {% csrf_token %}
          <div style="display:grid;grid-template-columns:1fr 220px;gap:16px">
            <div>
              <input type="text" id="tpl-name" name="name" placeholder="Template name" class="btn" required>
              <select id="tpl-audience" name="audience" class="btn" style="margin-top:12px">
                <option value="client">Clients</option>
                <option value="marketer">Marketers</option>
                <option value="both">Both</option>
              </select>
              <select id="tpl-channel" name="channel" class="btn" style="margin-top:12px">
                <option value="in_app">In-App</option>
                <option value="email">Email</option>
                <option value="sms">SMS</option>
              </select>

              <div id="email-subject-row" style="display:none;margin-top:12px">
                <input id="tpl-subject" name="subject" placeholder="Email subject" class="btn" required>
              </div>

              <div style="margin-top:12px">
                <div id="quill-full" style="height:220px;background:#fff;border-radius:8px"></div>
                <textarea id="tpl-body" name="body" style="display:none"></textarea>
                <div class="small" style="color:var(--muted);margin-top:8px">Placeholders: <code>{{ first_name }}</code>, <code>{{ full_name }}</code>, <code>{{ coupon_code }}</code></div>
              </div>
            </div>

            <div>
              <div style="font-weight:700;margin-bottom:12px">Schedule & Controls</div>
              <div style="margin-top:8px" class="small">Send time (local)</div>
              <input id="tpl-send-time" name="send_time_local" type="time" class="btn">
              <div style="margin-top:12px" class="small">Status</div>
              <select id="tpl-active" name="is_active" class="btn">
                <option value="True">Active</option>
                <option value="False">Disabled</option>
              </select>

              <div style="margin-top:16px" class="small">Advanced</div>
              <label class="small" style="margin-top:8px">A/B test</label>
              <select id="tpl-ab" class="btn">
                <option value="none">None</option>
                <option value="50-50">50/50 Split</option>
              </select>

              <div class="action-buttons">
                <button type="button" class="btn ghost" id="tpl-preview">Preview</button>
                <button type="button" class="btn primary" id="tpl-save">Save Template</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Preview modal -->
    <div class="modal-backdrop" id="preview-modal" style="display:none">
      <div class="modal-dialog">
        <h3>Preview</h3>
        <div id="preview-body" style="background:#fff;padding:16px;border-radius:10px;max-height:420px;overflow:auto;border:1px solid rgba(0,0,0,0.05)"></div>
        <div class="action-buttons">
          <button class="btn" id="preview-close">Close</button>
        </div>
      </div>
    </div>

    <!-- Schedule modal -->
    <div class="modal-backdrop" id="schedule-modal" style="display:none">
      <div class="modal-dialog">
        <h3>Schedule Message</h3>
        <form id="schedule-form">
          {% csrf_token %}
          <input type="hidden" name="user_id" id="schedule-user">
          <div class="small" style="color:var(--muted);margin-bottom:12px">Pick a date & time to send this message</div>
          <input type="date" id="schedule-date" class="btn" required>
          <input type="time" id="schedule-time" class="btn" style="margin-top:12px" required>
          <div class="action-buttons">
            <button class="btn" type="button" id="schedule-cancel">Cancel</button>
            <button class="btn primary" id="schedule-save" type="submit">Schedule</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  /* ------------------------- Bootstrap not required — vanilla handlers ------------------------- */
  const csrf = '{{ csrf_token }}';
  function $(q){ return document.querySelector(q); }
  function $all(q){ return Array.from(document.querySelectorAll(q)); }

  // show local time
  function updateLocalTime(){
    const now = new Date();
    $('#local-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }
  setInterval(updateLocalTime, 1000);
  updateLocalTime();

  // Autosend toggle
  const autoswitch = $('#autosend-switch');
  autoswitch.addEventListener('click', ()=> {
    autoswitch.classList.toggle('on');
    $('#autosend-label').innerText = autoswitch.classList.contains('on') ? 'Enabled' : 'Disabled';
    // call backend to update setting
    fetch("{% url 'admin_toggle_autosend' %}", {
      method:'POST', 
      headers:{
        'X-CSRFToken': csrf, 
        'Content-Type':'application/json'
      }, 
      body: JSON.stringify({enabled: autoswitch.classList.contains('on')})
    }).catch(()=>console.warn('toggle failed'));
  });

  // open template modal
  $('#open-new-template').addEventListener('click', openTemplateModal);
  $('#open-templates-page').addEventListener('click', ()=> location.href = "{% url 'admin_messaging_center' %}");

  // Quill editor initialization
  const quillFull = new Quill('#quill-full', { 
    theme: 'snow',
    modules: {
      toolbar: [
        ['bold', 'italic', 'underline'],
        [{'list': 'ordered'}, {'list': 'bullet'}],
        ['link', 'image'],
        ['clean']
      ]
    }
  });
  
  // Sync Quill content with hidden textarea
  quillFull.on('text-change', function() {
    $('#tpl-body').value = quillFull.root.innerHTML;
  });

  // show/hide email subject based on channel
  $('#tpl-channel').addEventListener('change', (e)=> {
    document.getElementById('email-subject-row').style.display = 
      e.target.value === 'email' ? 'block' : 'none';
  });

  // open main modal
  function openTemplateModal(){
    document.getElementById('modal-root').style.display = 'block';
    document.getElementById('tpl-modal').style.display = 'flex';
    // reset content
    $('#tpl-name').value = '';
    $('#tpl-subject').value = '';
    quillFull.setText('');
    $('#tpl-send-time').value = '';
  }
  
  $('#tpl-close').addEventListener('click', hideAllModals);
  $('#preview-close').addEventListener('click', hideAllModals);
  $('#schedule-cancel').addEventListener('click', hideAllModals);

  // hide modals util
  function hideAllModals(){
    ['tpl-modal','preview-modal','schedule-modal'].forEach(id=>{ 
      const el = document.getElementById(id); 
      if (el) el.style.display='none'; 
    });
    document.getElementById('modal-root').style.display='none';
  }
  
  $('#tpl-save').addEventListener('click', async ()=> {
    // gather fields and POST to create template endpoint
    const payload = new FormData();
    payload.append('name', $('#tpl-name').value);
    payload.append('audience', $('#tpl-audience').value);
    payload.append('channel', $('#tpl-channel').value);
    payload.append('subject', $('#tpl-subject').value || '');
    payload.append('body', quillFull.root.innerHTML);
    payload.append('send_time_local', $('#tpl-send-time').value || '');
    payload.append('is_active', $('#tpl-active').value);
    
    try {
      const r = await fetch("{% url 'api_create_template' %}", { 
        method: 'POST', 
        headers: { 'X-CSRFToken': csrf }, 
        body: payload 
      });
      
      if (r.ok) { 
        hideAllModals(); 
        location.reload();
      } else { 
        const errorData = await r.json();
        alert(`Error saving template: ${errorData.errors || 'Unknown error'}`); 
      }
    } catch (error) {
      console.error('Error saving template:', error);
      alert('Error saving template. Please try again.');
    }
  });

  // Preview button in card -> render preview via backend (safe)
  $all('[data-action="preview"]').forEach(b => b.addEventListener('click', async (ev)=> {
    const userId = ev.currentTarget.dataset.user;
    try {
      const r = await fetch("{% url 'api_preview_for_user' %}?user_id=" + userId);
      if (!r.ok) return alert('Preview failed');
      const data = await r.json();
      $('#preview-body').innerHTML = data.rendered || '<em>No preview</em>';
      document.getElementById('modal-root').style.display='block';
      document.getElementById('preview-modal').style.display='flex';
    } catch (error) {
      console.error('Preview error:', error);
      alert('Error loading preview');
    }
  }));

  // Send now for a user
  $all('[data-action="send"]').forEach(b => b.addEventListener('click', async (ev) => {
    const uid = ev.currentTarget.dataset.user;
    if (!confirm('Send wish now to this user?')) return;
    
    try {
      const r = await fetch("{% url 'api_send_now' %}", { 
        method: 'POST', 
        headers: {
          'X-CSRFToken': csrf, 
          'Content-Type': 'application/json' 
        }, 
        body: JSON.stringify({ user_id: uid }) 
      });
      
      if (r.ok) { 
        alert('Queued for send'); 
        location.reload();
      } else { 
        alert('Send failed'); 
      }
    } catch (error) {
      console.error('Send error:', error);
      alert('Error sending message');
    }
  }));

  // Queue action
  $all('[data-action="queue"]').forEach(b => b.addEventListener('click', async (ev)=> {
    const uid = ev.currentTarget.dataset.user;
    try {
      const r = await fetch("{% url 'api_queue_for_send' %}", { 
        method: 'POST', 
        headers: { 
          'X-CSRFToken': csrf, 
          'Content-Type': 'application/json' 
        }, 
        body: JSON.stringify({ user_id: uid }) 
      });
      
      if (r.ok) {
        alert('Added to queue'); 
        location.reload();
      } else {
        alert('Queue failed'); 
      }
    } catch (error) {
      console.error('Queue error:', error);
      alert('Error queuing message');
    }
  }));

  // Schedule from Upcoming list
  $all('[data-action="schedule"]').forEach(b => b.addEventListener('click', (ev)=>{
    const uid = ev.currentTarget.dataset.user;
    const date = ev.currentTarget.dataset.date;
    document.getElementById('schedule-user').value = uid;
    document.getElementById('schedule-date').value = date;
    document.getElementById('schedule-time').value = '09:00'; // default time
    document.getElementById('modal-root').style.display='block';
    document.getElementById('schedule-modal').style.display='flex';
  }));

  $('#schedule-save').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const payload = new FormData($('#schedule-form'));
    
    try {
      const r = await fetch("{% url 'api_schedule_send' %}", { 
        method: 'POST', 
        headers: { 'X-CSRFToken': csrf }, 
        body: payload 
      });
      
      if (r.ok) { 
        hideAllModals(); 
        alert('Scheduled'); 
        location.reload();
      } else {
        alert('Schedule failed'); 
      }
    } catch (error) {
      console.error('Schedule error:', error);
      alert('Error scheduling message');
    }
  });

  // Quick-form submit (create quick template)
  $('#quick-form').addEventListener('submit', async (ev)=> {
    ev.preventDefault();
    const fd = new FormData(ev.target);
    
    try {
      const r = await fetch("{% url 'api_create_template' %}", { 
        method: 'POST', 
        headers: { 'X-CSRFToken': csrf }, 
        body: fd 
      });
      
      if (r.ok) { 
        alert('Template created'); 
        ev.target.reset(); 
        location.reload();
      } else {
        const errorData = await r.json();
        alert(`Create failed: ${errorData.errors || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('Create template error:', error);
      alert('Error creating template');
    }
  });

  // Manage templates & perf chart
  async function loadDashboard(){
    // reload sections via fetch or refresh page — fetch minimal endpoints
    // Perf chart
    try {
      const chartData = {{ chart_data|safe }};
      var options = {
        chart: { 
          type: 'area', 
          height: 160, 
          toolbar: { show: false },
          zoom: { enabled: false },
          animations: { enabled: true }
        },
        series: chartData.series,
        xaxis: { 
          categories: chartData.labels,
          labels: { style: { colors: '#64748b', fontSize: '11px' } }
        },
        yaxis: { show: false },
        stroke: { 
          curve: 'smooth',
          width: 3
        },
        colors: [getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#0b6efd'],
        tooltip: {
          theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light',
          x: { show: false }
        },
        dataLabels: { enabled: false },
        grid: { show: false },
        fill: {
          type: 'gradient',
          gradient: {
            shadeIntensity: 1,
            opacityFrom: 0.7,
            opacityTo: 0.1,
            stops: [0, 100]
          }
        }
      };
      var chart = new ApexCharts(document.querySelector("#perf-chart"), options);
      chart.render();
    } catch(e){ console.warn('chart error', e) }
  }
  loadDashboard();

  // auto-refresh upcoming list
  document.getElementById('refresh-upcoming').addEventListener('click', ()=> {
    fetch("{% url 'api_upcoming_birthdays' %}").then(r=>r.json()).then(d=>{
      // optionally re-render the upcoming list (omitted for brevity)
      location.reload();
    });
  });

  // export logs
  $('#audit-export').addEventListener('click', ()=> { 
    window.location = "{% url 'admin_export_birthday_logs' %}"; 
  });

  // initial bindings for template actions: preview/edit on template cards
  $all('[data-action="tpl-preview"]').forEach(b=> b.addEventListener('click', async ev => {
    const id = ev.currentTarget.dataset.id;
    try {
      const r = await fetch("{% url 'api_preview_template' pk=1 %}".replace('/0/', '/' + id + '/'));
      if (!r.ok) return alert('Preview failed');
      const data = await r.json();
      $('#preview-body').innerHTML = data.rendered || '<em>No preview</em>'; 
      document.getElementById('modal-root').style.display='block'; 
      document.getElementById('preview-modal').style.display='flex';
    } catch (error) {
      console.error('Template preview error:', error);
      alert('Error loading template preview');
    }
  }));
  
  $all('[data-action="tpl-edit"]').forEach(b => b.addEventListener('click', ev=>{
    const id = ev.currentTarget.dataset.id;
    window.location = "{% url 'api_update_template' 0 %}".replace('/0/','/' + id + '/'); 
  }));

  </script>
</main>
{% endblock %}