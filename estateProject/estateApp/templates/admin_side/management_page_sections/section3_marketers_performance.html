<!-- Marketers Performance Tab -->
<div class="tab-pane fade show active" id="ranking" role="tabpanel" aria-labelledby="ranking-tab">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="card-title mb-0 text-primary">
            <i class="bi bi-trophy-fill me-2"></i>Performance Rankings
        </h3>
        <div>
            <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#setTargetModal">
                <i class="bi bi-bullseye me-2"></i>Set Targets
            </button>
            <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#setCommissionModal">
                <i class="bi bi-percent me-2"></i>Set Commission
            </button>
            <!-- <button class="btn btn-primary" id="exportRankingsBtn">
                <i class="bi bi-download me-2"></i>Export Report
            </button> -->
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <label for="filterPeriodType" class="form-label">Period Type</label>
            <select class="form-select" id="filterPeriodType">
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="annual">Annual</option>
            </select>
        </div>
        <div class="col-md-5">
            <label for="filterSpecificPeriod" class="form-label">Select Period</label>
            <select class="form-select" id="filterSpecificPeriod">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-outline-secondary w-100" id="resetFilterBtn">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
            </button>
        </div>
    </div>

    <!-- Top 5 Leaderboard -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-stars text-warning me-2"></i> Top 5 Performers
            </h5>
            <span class="badge bg-primary" id="leaderboardPeriodLabel">Current Period</span>
        </div>
        <div class="card-body p-0">
            <div class="leaderboard-list" id="leaderboardList">
                <div class="text-center py-5" id="loadingLeaderboard">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading performance data...</p>
                </div>
            </div>
        </div>
        <div class="card-footer bg-light text-center">
            <button class="btn btn-sm btn-outline-primary" id="showAllMarketersBtn">
                <i class="bi bi-arrow-down-circle me-1"></i>Show All Marketers
            </button>
        </div>
    </div>

    <!-- Full Marketers Table -->
    <div class="card mb-4" id="allMarketersTable" style="display: none;">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-table me-2 text-primary"></i>All Marketers Performance - 
                <span id="tablePeriodLabel">Current Period</span> 
                <span id="tableTargetLabel" class="ms-2">No Target Set</span>
            </h5>
            <div>
                <button class="btn btn-outline-secondary btn-sm me-2" id="downloadPdfBtn">
                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                </button>
                <button class="btn btn-outline-success btn-sm" id="downloadExcelBtn">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i>Excel
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="performanceTable">
                    <thead class="table-light">
                        <tr>
                            <th>Rank</th>
                            <th>Marketer</th>
                            <th>Closed Deals</th>
                            <th>Total Sales (₦)</th>
                            <th>Commission %</th>
                            <th>Commission Earned (₦)</th>
                            <th>Target Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="loadingTable">
                            <td colspan="8" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading performance data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="setTargetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-bullseye me-2"></i>Set Performance Targets</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="targetForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Period Type</label>
                                <select class="form-select" id="periodType" name="period_type" required>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Select Period</label>
                                <select class="form-select" id="specificPeriod" name="specific_period" required>
                                    <!-- Options injected by JS -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Select Marketer</label>
                            <select class="form-select" id="targetMarketer" name="marketer" disabled required>
                                <option value="all">All Marketers</option>
                                <!-- Marketers injected by JS -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Sales Target (₦)</label>
                            <input type="number" class="form-control" name="target_amount" placeholder="Enter target amount" min="0" step="1000" required>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="notifyMarketer" name="notify">
                            <label class="form-check-label" for="notifyMarketer">
                                Notify marketer about this target
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTargetBtn">Save Target</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="setCommissionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-percent me-2"></i>Set Commission Rate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="commissionForm">
                        <div class="mb-3">
                            <label class="form-label">Select Marketer</label>
                            <select class="form-select" id="commissionMarketer" name="marketer" required>
                                <!-- <option value="all">All Marketers</option> -->
                                <!-- Marketers injected by JS -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Commission Rate (%)</label>
                            <input type="number" class="form-control" name="commission_rate" 
                                   placeholder="Enter commission percentage" min="0" max="100" step="0.1" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Effective Date</label>
                            <input type="date" class="form-control" name="effective_date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="saveCommissionBtn">Save Commission</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="sendMessageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-send me-2"></i>Send Message to Marketer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="messageForm">
                        <div class="mb-3">
                            <label class="form-label">To</label>
                            <input type="text" class="form-control" id="messageRecipient" readonly name="recipient">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" rows="4" placeholder="Type your message here" name="message" required>Congratulations! We are happy to let you know that you won the Top Marketer Performer of the month. We have a prize for you, please come to the office of the manager to retrieve your reward.</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Send Via</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendEmail" name="email" checked>
                                <label class="form-check-label" for="sendEmail">
                                    <i class="bi bi-envelope me-1"></i> Email
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendSMS" name="sms" checked>
                                <label class="form-check-label" for="sendSMS">
                                    <i class="bi bi-chat-text me-1"></i> SMS
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendApp" name="app" checked>
                                <label class="form-check-label" for="sendApp">
                                    <i class="bi bi-bell me-1"></i> App Notification
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="sendMessageBtn">Send Message</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global state
    let currentPerformanceData = [];
    let marketersList = [];
    let debounceTimer;
    let currentPeriods = [];

    // Get human-readable period label
    function getPeriodLabel(periodType, specificPeriod) {
        if (periodType === 'monthly') {
            const [year, month] = specificPeriod.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleString('default', { month: 'long', year: 'numeric' });
        } else if (periodType === 'quarterly') {
            const [year, quarter] = specificPeriod.split('-');
            return `${quarter} ${year}`;
        } else if (periodType === 'annual') {
            return specificPeriod;
        }
        return specificPeriod;
    }

    // Get CSRF token for POST requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Populate periods for target modal
    function populateTargetPeriods(periodType, specificPeriodElement) {
        specificPeriodElement.innerHTML = '';
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const currentQuarter = Math.floor((currentMonth - 1) / 3) + 1;

        let periods = [];

        if (periodType === 'monthly') {
            for (let year = currentYear; year >= currentYear - 1; year--) {
                const startMonth = year === currentYear ? 1 : 1;
                const endMonth = year === currentYear ? currentMonth : 12;
                
                for (let month = startMonth; month <= endMonth; month++) {
                    const period = `${year}-${String(month).padStart(2, '0')}`;
                    const label = new Date(year, month - 1, 1).toLocaleString('default', { month: 'long', year: 'numeric' });
                    periods.push({ value: period, label: label });
                }
            }
        } else if (periodType === 'quarterly') {
            for (let year = currentYear; year >= currentYear - 1; year--) {
                const startQuarter = year === currentYear ? 1 : 1;
                const endQuarter = year === currentYear ? currentQuarter : 4;
                
                for (let quarter = startQuarter; quarter <= endQuarter; quarter++) {
                    const period = `${year}-Q${quarter}`;
                    periods.push({ value: period, label: `Q${quarter} ${year}` });
                }
            }
        } else { // annual
            for (let year = currentYear; year >= currentYear - 4; year--) {
                periods.push({ value: String(year), label: String(year) });
            }
        }

        periods.forEach(period => {
            const option = document.createElement('option');
            option.value = period.value;
            option.textContent = period.label;
            specificPeriodElement.appendChild(option);
        });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
          // Load marketers from backend
          const marketersResponse = await fetch('/api/marketers/');
          if (!marketersResponse.ok) throw new Error('Failed to load marketers');
          marketersList = await marketersResponse.json();
          
          populateMarketerDropdowns();
          populateSpecificPeriods();

          // Initialize date inputs
          const effectiveDateInput = document.querySelector('#setCommissionModal input[name="effective_date"]');
          if (effectiveDateInput) {
              effectiveDateInput.valueAsDate = new Date();
          }

          // Wire up listeners
          setupEventListeners();

          // First load
          updatePerformance();
      } catch (err) {
          console.error(err);
          showToast('Initialization failed: ' + err.message, 'danger');
      }
    });

    // Populate marketer dropdowns
    function populateMarketerDropdowns() {
        const targetDropdown = document.getElementById('targetMarketer');
        targetDropdown.innerHTML = '<option value="all">All Marketers</option>';
        
        marketersList.forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.full_name;
            targetDropdown.appendChild(option);
        });

        const commissionDropdown = document.getElementById('commissionMarketer');
        commissionDropdown.innerHTML = '';
        
        marketersList.forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.full_name;
            commissionDropdown.appendChild(option);
        });
    }

    // when the commission select changes, fetch last commission
    document.getElementById('commissionMarketer')
            .addEventListener('change', async function() {
        const marketerId = this.value;
        const rateInput = document.querySelector('#commissionForm input[name="commission_rate"]');
        const dateInput = document.querySelector('#commissionForm input[name="effective_date"]');

        // clear while loading
        rateInput.value = '';
        dateInput.value = '';

        try {
            const res = await fetch(`/api/get-commission/?marketer=${marketerId}`);
            const json = await res.json();
            if (res.ok && json.commission_rate != null) {
                rateInput.value = json.commission_rate;
                dateInput.value = json.effective_date;
            }
        } catch(err) {
            console.error('Could not load commission:', err);
        }
    });

    function populateSpecificPeriods() {
        const type = document.getElementById("filterPeriodType").value;
        const sel  = document.getElementById("filterSpecificPeriod");
        if (!sel) return;
        
        sel.innerHTML = '';

        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const currentQuarter = Math.floor((currentMonth - 1) / 3) + 1;
        
        let opts = [];
        currentPeriods = [];

        if (type === 'monthly') {
            for (let year = currentYear; year >= currentYear - 1; year--) {
                const startMonth = year === currentYear ? 1 : 1;
                const endMonth = year === currentYear ? currentMonth : 12;
                
                for (let month = startMonth; month <= endMonth; month++) {
                    const period = `${year}-${String(month).padStart(2, '0')}`;
                    const d = new Date(year, month - 1, 1);
                    opts.push({ 
                        val: period, 
                        lbl: `${d.toLocaleString('default', {month: 'long'})} ${year}`, 
                        sel: year === currentYear && month === currentMonth
                    });
                    currentPeriods.push(period);
                }
            }
        } else if (type === 'quarterly') {
            for (let year = currentYear; year >= currentYear - 1; year--) {
                const startQuarter = year === currentYear ? 1 : 1;
                const endQuarter = year === currentYear ? currentQuarter : 4;
                
                for (let quarter = startQuarter; quarter <= endQuarter; quarter++) {
                    const period = `${year}-Q${quarter}`;
                    opts.push({ 
                        val: period, 
                        lbl: `Q${quarter} ${year}`, 
                        sel: year === currentYear && quarter === currentQuarter
                    });
                    currentPeriods.push(period);
                }
            }
        } else { // annual
            for (let year = currentYear; year >= currentYear - 4; year--) {
                const period = `${year}`;
                opts.push({ 
                    val: period, 
                    lbl: `${year}`, 
                    sel: year === currentYear
                });
                currentPeriods.push(period);
            }
        }

        opts.forEach(o => {
            const el = document.createElement('option');
            el.value = o.val; 
            el.textContent = o.lbl;
            if (o.sel) el.selected = true;
            sel.append(el);
        });
    }

    // Set up event listeners
    function setupEventListeners(){
        document.getElementById("filterPeriodType").addEventListener('change', () => {
            populateSpecificPeriods();
            updatePerformance();
        });
        
        document.getElementById("filterSpecificPeriod").addEventListener('change', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updatePerformance, 300);
        });
        
        document.getElementById('resetFilterBtn').addEventListener('click', () => {
            document.getElementById("filterPeriodType").value = 'monthly';
            populateSpecificPeriods();
            updatePerformance();
        });
        
        document.getElementById('showAllMarketersBtn').addEventListener('click', () => {
            const tbl = document.getElementById('allMarketersTable');
            if (tbl) {
                const show = tbl.style.display !== 'block';
                tbl.style.display = show ? 'block' : 'none';
                document.getElementById('showAllMarketersBtn').innerHTML = show
                    ? '<i class="bi bi-arrow-up-circle me-1"></i>Hide Marketers'
                    : '<i class="bi bi-arrow-down-circle me-1"></i>Show All Marketers';
            }
        });
        
        // document.getElementById("exportRankingsBtn")?.addEventListener("click", exportCSV);
        document.getElementById("downloadPdfBtn")?.addEventListener("click", exportPDF);
        document.getElementById("downloadExcelBtn")?.addEventListener("click", exportExcel);
        document.getElementById("saveTargetBtn")?.addEventListener("click", saveTarget);
        document.getElementById("saveCommissionBtn")?.addEventListener("click", saveCommission);
        document.getElementById("sendMessageBtn")?.addEventListener("click", sendMessage);
        
        const messageModal = document.getElementById('sendMessageModal');
        if (messageModal) {
            messageModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const marketer = button.getAttribute('data-marketer');
                document.getElementById('messageRecipient').value = marketer;
            });
        }
        
        // Update target periods when period type changes in modal
        const periodTypeElem = document.getElementById('periodType');
        if (periodTypeElem) {
            periodTypeElem.addEventListener('change', function() {
                const specificPeriodElement = document.getElementById('specificPeriod');
                if (specificPeriodElement) {
                    populateTargetPeriods(this.value, specificPeriodElement);
                }
            });
        }
        
        // Initialize target periods when modal opens
        const targetModal = document.getElementById('setTargetModal');
        if (targetModal) {
            targetModal.addEventListener('show.bs.modal', function() {
                const periodType = document.getElementById('periodType').value;
                const specificPeriodElement = document.getElementById('specificPeriod');
                if (specificPeriodElement) {
                    populateTargetPeriods(periodType, specificPeriodElement);
                }
            });
        }
    }

    async function updatePerformance() {
        try {
            // Show loaders
            const leaderboardLoading = document.getElementById("loadingLeaderboard");
            const tableLoading = document.getElementById("loadingTable");
            
            if (leaderboardLoading) leaderboardLoading.style.display = 'block';
            if (tableLoading) tableLoading.style.display = 'table-row';

            const pt = document.getElementById("filterPeriodType").value;
            const sp = document.getElementById("filterSpecificPeriod").value;
            
            // Fetch from backend
            const response = await fetch(`/api/performance-data/?period_type=${pt}&specific_period=${sp}`);
            if (!response.ok) throw new Error('Network response was not ok');
            currentPerformanceData = await response.json();
            
            // Get period label
            const periodLabel = getPeriodLabel(pt, sp);
            document.getElementById("leaderboardPeriodLabel").textContent = periodLabel;
            document.getElementById("tablePeriodLabel").textContent = periodLabel;
            
            // Update target label
            updateTargetLabel(currentPerformanceData);
            
            // Render both sections
            renderLeaderboard(currentPerformanceData);
            renderFullTable(currentPerformanceData, pt, sp);

        } catch(err) {
            console.error("Performance data error:", err);
            showToast('Failed to load performance data: ' + err.message, 'danger');
            
            // Clear any existing data
            const leaderboardList = document.getElementById("leaderboardList");
            if (leaderboardList) {
                leaderboardList.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-exclamation-circle display-6"></i>
                        <p class="mt-3">Failed to load performance data</p>
                    </div>`;
            }
            
            const tableBody = document.querySelector("#performanceTable tbody");
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr><td colspan="8" class="text-center py-5 text-muted">
                        <i class="bi bi-exclamation-circle display-6"></i>
                        <p class="mt-3">Failed to load performance data</p>
                    </td></tr>`;
            }
        } finally {
            // Hide loaders
            const leaderboardLoading = document.getElementById("loadingLeaderboard");
            const tableLoading = document.getElementById("loadingTable");
            
            if (leaderboardLoading) leaderboardLoading.style.display = 'none';
            if (tableLoading) tableLoading.style.display = 'none';
        }
    }

  

  // Calculate target label
    function updateTargetLabel(data) {
        const targetLabel = document.getElementById("tableTargetLabel");
        if (!targetLabel) return;

        // Extract only marketers with targets
        const targets = data
            .map(item => item.target_amount || 0)
            .filter(amount => amount > 0);

        if (targets.length) {
            // Calculate average target
            const sum = targets.reduce((sum, amt) => sum + amt, 0);
            const avgTarget = sum / targets.length;
            targetLabel.textContent = `Target: ₦${formatNumber(avgTarget)}`;
            targetLabel.className = "ms-2 text-success fw-bold";
        } else {
            targetLabel.textContent = 'No Target Set';
            targetLabel.className = "ms-2 text-muted";
        }
    }


    // Render leaderboard
    function renderLeaderboard(data) {
        const container = document.getElementById("leaderboardList");
        if (!container) return;
        
        container.innerHTML = '';
        
        if (!data || data.length === 0) {
            return container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-circle display-6"></i>
                    <p class="mt-3">No performance records for the selected period</p>
                </div>`;
        }
        
        // Filter marketers with actual performance
        const performers = data.filter(item => item.total_sales > 0 || item.closed_deals > 0);
        
        if (performers.length === 0) {
            return container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-circle display-6"></i>
                    <p class="mt-3">No performers for the selected period</p>
                </div>`;
        }
        
        // Sort by total sales (descending) and take top 5
        performers.sort((a, b) => b.total_sales - a.total_sales).slice(0, 5)
            .forEach((item, index) => {
                const rank = index + 1;
                const div = document.createElement('div');
                div.className = 'leaderboard-item p-3 border-bottom';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="rank-badge bg-${getRankColor(rank)} text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width:36px;height:36px;">
                                <span class="fw-bold">${rank}</span>
                            </div>
                            <div>
                                <h6 class="mb-0">${item.marketer_name}</h6>
                                <small class="text-muted">${item.closed_deals} deals</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-0 text-primary">₦${formatNumber(item.total_sales)}</h5>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i> ${formatNumber(item.commission_earned)} earned
                            </small>
                        </div>
                    </div>`;
                container.append(div);
            });
    }

    // Render full table with all marketers
    function renderFullTable(data, periodType, specificPeriod) {
        const tbody = document.querySelector("#performanceTable tbody");
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (!data || data.length === 0) {
            return tbody.innerHTML = `
                <tr><td colspan="8" class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-circle display-6"></i>
                    <p class="mt-3">No performance records for the selected period</p>
                </td></tr>`;
        }
        
        // Separate marketers with data and without
        const marketersWithData = data.filter(item => item.total_sales > 0 || item.closed_deals > 0);
        const marketersWithoutData = data.filter(item => !(item.total_sales > 0 || item.closed_deals > 0));
        
        // Sort marketers with data by total sales (descending)
        marketersWithData.sort((a, b) => b.total_sales - a.total_sales);
        
        // Combine both lists
        const sortedData = [...marketersWithData, ...marketersWithoutData];
        
        let rank = 1;
        sortedData.forEach((item) => {
            const hasData = item.total_sales > 0 || item.closed_deals > 0;
            const commClass = item.commission_rate >= 10 ? 'text-success fw-bold' : 'text-primary';
            
            // Calculate target status with beautiful badges
            let targetStatus = '';
            let targetClass = '';
            
            if (item.target_amount > 0 && hasData) {
                const targetPercent = Math.round((item.total_sales / item.target_amount) * 100) || 0;
                
                if (targetPercent >= 100) {
                    const above = targetPercent - 100;
                    if (above === 0) {
                        targetStatus = 'Target Achieved';
                        targetClass = 'bg-primary';
                    } else if (above <= 10) {
                        targetStatus = `${above}% Above Target`;
                        targetClass = 'bg-success';
                    } else if (above <= 25) {
                        targetStatus = `${above}% Above Target`;
                        targetClass = 'bg-teal';
                    } else if (above <= 50) {
                        targetStatus = `${above}% Above Target`;
                        targetClass = 'bg-indigo';
                    } else {
                        targetStatus = `${above}% Above Target`;
                        targetClass = 'bg-purple';
                    }
                } else {
                    const below = 100 - targetPercent;
                    if (below <= 10) {
                        targetStatus = `${below}% Below Target`;
                        targetClass = 'bg-warning';
                    } else if (below <= 25) {
                        targetStatus = `${below}% Below Target`;
                        targetClass = 'bg-orange';
                    } else if (below <= 50) {
                        targetStatus = `${below}% Below Target`;
                        targetClass = 'bg-coral';
                    } else {
                        targetStatus = `${below}% Below Target`;
                        targetClass = 'bg-danger';
                    }
                }
            } else if (item.target_amount > 0) {
                targetStatus = 'No Sales Yet';
                targetClass = 'bg-secondary';
            } else {
                targetStatus = 'No Target Set';
                targetClass = 'bg-secondary';
            }

            const rowClass = hasData ? '' : 'no-data-row';
            
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="${rowClass}">
                    <td>${hasData ? rank++ : '-'}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-light rounded-circle me-2 d-flex align-items-center justify-content-center">
                                <span class="text-primary fw-bold">${item.marketer_name.charAt(0)}</span>
                            </div>
                            ${item.marketer_name}
                        </div>
                    </td>
                    <td>${hasData ? item.closed_deals : '-'}</td>
                    <td class="fw-bold">${hasData ? `₦${formatNumber(item.total_sales)}` : '-'}</td>
                    <td class="${commClass}">${hasData ? `${item.commission_rate}%` : '-'}</td>
                    <td class="text-success fw-bold">${hasData ? `₦${formatNumber(item.commission_earned)}` : '-'}</td>
                    <td>
                        <span class="badge ${targetClass}">${targetStatus}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#sendMessageModal" data-marketer="${item.marketer_name}" ${!hasData ? 'disabled' : ''}>
                            <i class="bi bi-send"></i>
                        </button>
                    </td>
                </tr>`);
        });
    }

    // Get rank color
    function getRankColor(rank) {
        if (rank === 1) return 'gold';
        if (rank === 2) return 'silver';
        if (rank === 3) return 'bronze';
        return 'primary';
    }

    // Format numbers with commas
    function formatNumber(num) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(num);
    }

    // target prefill
    async function fetchAndPrefillTarget() {
        const form = document.getElementById('targetForm');
        const marketerSelect = document.getElementById('targetMarketer');
        const amountInput = form.querySelector('input[name="target_amount"]');
        const periodType = form.period_type.value;
        const specificPeriod = form.specific_period.value;
        
        if (!periodType || !specificPeriod) return;
        
        amountInput.value = '';
        const marketerId = marketerSelect.value;

        try {
            const url = `/api/get-target/?period_type=${periodType}&specific_period=${encodeURIComponent(specificPeriod)}&marketer=${marketerId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch target');
            
            const data = await response.json();
            if (data.target_amount) {
                amountInput.value = data.target_amount;
            }
        } catch (error) {
            console.error('Error fetching target:', error);
        }
    }


    // — Event wiring —

    // 1) When the modal opens
    document.getElementById('setTargetModal')
      .addEventListener('show.bs.modal', () => {
        // First populate the specificPeriod options
        const ptElem = document.getElementById('periodType');
        const spElem = document.getElementById('specificPeriod');
        populateTargetPeriods(ptElem.value, spElem);

        // Then prefill the Sales Target field
        fetchAndPrefillTarget();
      });

    // 2) When marketer changes
    document.getElementById('targetMarketer')
      .addEventListener('change', fetchAndPrefillTarget);

    // 3) When period type changes
    document.getElementById('periodType')
      .addEventListener('change', () => {
        const spElem = document.getElementById('specificPeriod');
        populateTargetPeriods(document.getElementById('periodType').value, spElem);
        fetchAndPrefillTarget();
      });

    // 4) When specific period changes
    document.getElementById('specificPeriod')
      .addEventListener('change', fetchAndPrefillTarget);
      

    async function saveTarget() {
      const form = document.getElementById("targetForm");
      const payload = {
        period_type: form.period_type.value,
        specific_period: form.specific_period.value,
        marketer: form.marketer.value,
        target_amount: Number(form.target_amount.value)
      };

      try {
        const csrftoken = getCookie('csrftoken');
        const res = await fetch('/api/set-target/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (!res.ok || result.status !== 'success') {
          throw new Error(result.message || 'Failed to set target');
        }
        showToast('Target set successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('setTargetModal')).hide();
        form.reset();
        updatePerformance();
      } catch (err) {
        console.error(err);
        showToast('Failed to set target: ' + err.message, 'danger');
      }
    }

    async function saveCommission() {
        const form = document.getElementById("commissionForm");
        const payload = {
            marketer: form.marketer.value,
            commission_rate: Number(form.commission_rate.value),
            effective_date: form.effective_date.value
        };

        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch('/api/set-commission/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            
            if (!response.ok || result.status !== 'success') {
                throw new Error(result.message || 'Failed to set commission');
            }
            
            showToast('Commission updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('setCommissionModal')).hide();
            form.reset();
            updatePerformance();
        } catch (error) {
            console.error('Commission error:', error);
            showToast(`Failed to set commission: ${error.message}`, 'danger');
        }
    }

    async function sendMessage() {
        const form = document.getElementById("messageForm");
        try {
            showToast('Message sent successfully!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
            if (modal) modal.hide();
            
            form.reset();
        } catch (error) {
            console.error('Message error:', error);
            showToast('Failed to send message', 'danger');
        }
    }

    // Export functions
    function exportCSV() {
        if (!currentPerformanceData.length) {
            showToast('No data to export', 'warning');
            return;
        }
        
        const pt = document.getElementById("filterPeriodType").value;
        const sp = document.getElementById("filterSpecificPeriod").value;
        const periodLabel = getPeriodLabel(pt, sp).replace(/ /g, '_');
        
        // Create CSV header
        let csvContent = "Rank,Marketer,Closed Deals,Total Sales (₦),Commission %,Commission Earned (₦),Target Status\n";
        
        // Sort data by total sales
        const sortedData = [...currentPerformanceData].sort((a, b) => b.total_sales - a.total_sales);
        
        // Add rows
        sortedData.forEach((item, index) => {
            const hasData = item.total_sales > 0 || item.closed_deals > 0;
            const row = [
                hasData ? index + 1 : '-',
                `"${item.marketer_name}"`,
                hasData ? item.closed_deals : '-',
                hasData ? `₦${formatNumber(item.total_sales)}` : '-',
                hasData ? `${item.commission_rate}%` : '-',
                hasData ? `₦${formatNumber(item.commission_earned)}` : '-',
                `"${getTargetStatusText(item)}"`
            ];
            csvContent += row.join(',') + '\n';
        });
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `marketer_performance_${periodLabel}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function getTargetStatusText(item) {
        if (item.target_amount > 0 && (item.total_sales > 0 || item.closed_deals > 0)) {
            const targetPercent = Math.round((item.total_sales / item.target_amount) * 100) || 0;
            
            if (targetPercent >= 100) {
                const above = targetPercent - 100;
                if (above === 0) return 'Target Achieved';
                return `${above}% Above Target`;
            } else {
                const below = 100 - targetPercent;
                return `${below}% Below Target`;
            }
        } else if (item.target_amount > 0) {
            return 'No Sales Yet';
        }
        return 'No Target Set';
    }
    
    function exportExcel() {
        if (!currentPerformanceData.length) {
            showToast('No data to export', 'warning');
            return;
        }
        
        const pt = document.getElementById("filterPeriodType").value;
        const sp = document.getElementById("filterSpecificPeriod").value;
        const periodLabel = getPeriodLabel(pt, sp).replace(/ /g, '_');
        
        // Prepare worksheet data
        const wsData = [
            ['Rank', 'Marketer', 'Closed Deals', 'Total Sales (₦)', 'Commission %', 'Commission Earned (₦)', 'Target Status']
        ];
        
        // Sort data by total sales
        const sortedData = [...currentPerformanceData].sort((a, b) => b.total_sales - a.total_sales);
        
        // Add rows
        sortedData.forEach((item, index) => {
            const hasData = item.total_sales > 0 || item.closed_deals > 0;
            wsData.push([
                hasData ? index + 1 : '-',
                item.marketer_name,
                hasData ? item.closed_deals : '-',
                hasData ? `₦${formatNumber(item.total_sales)}` : '-',
                hasData ? `${item.commission_rate}%` : '-',
                hasData ? `₦${formatNumber(item.commission_earned)}` : '-',
                getTargetStatusText(item)
            ]);
        });
        
        // Create workbook and worksheet
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Performance');
        
        // Export to file
        XLSX.writeFile(wb, `marketer_performance_${periodLabel}.xlsx`);
    }
    
    function exportPDF() {
        if (!currentPerformanceData.length) {
            showToast('No data to export', 'warning');
            return;
        }
        
        const pt = document.getElementById("filterPeriodType").value;
        const sp = document.getElementById("filterSpecificPeriod").value;
        const periodLabel = getPeriodLabel(pt, sp);
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(16);
        doc.text(`Marketers Performance Report - ${periodLabel}`, 105, 15, null, null, 'center');
        
        // Add table
        const headers = ['Rank', 'Marketer', 'Closed Deals', 'Total Sales (₦)', 'Commission %', 'Commission Earned (₦)', 'Target Status'];
        const data = [];
        
        // Sort data by total sales
        const sortedData = [...currentPerformanceData].sort((a, b) => b.total_sales - a.total_sales);
        
        // Prepare data rows
        sortedData.forEach((item, index) => {
            const hasData = item.total_sales > 0 || item.closed_deals > 0;
            data.push([
                hasData ? (index + 1).toString() : '-',
                item.marketer_name,
                hasData ? item.closed_deals.toString() : '-',
                hasData ? `₦${formatNumber(item.total_sales)}` : '-',
                hasData ? `${item.commission_rate}%` : '-',
                hasData ? `₦${formatNumber(item.commission_earned)}` : '-',
                getTargetStatusText(item)
            ]);
        });
        
        // Generate table
        doc.autoTable({
            head: [headers],
            body: data,
            startY: 25,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 2 },
            headStyles: { fillColor: [41, 128, 185] }
        });
        
        // Save PDF
        doc.save(`marketer_performance_${periodLabel.replace(/ /g, '_')}.pdf`);
    }

    // Show toast notification
    function showToast(message, type) {
        let toastContainer = document.getElementById("toastContainer");
        if (!toastContainer) {
            toastContainer = document.createElement("div");
            toastContainer.id = "toastContainer";
            toastContainer.className = "toast-container position-fixed bottom-0 end-0 p-3";
            toastContainer.style.zIndex = "11";
            document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Initialize and show the toast
        const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 5000 });
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
</script>

<style>
  #ranking .card-title {
    font-weight: 600;
  }
  
  .leaderboard-item {
    transition: background-color 0.2s;
  }
  
  .leaderboard-item:hover {
    background-color: rgba(41, 128, 185, 0.05);
  }
  
  .rank-badge {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border-radius: 50%;
  }
  
  .rank-badge.bg-gold { background-color: #FFD700; color: #000; }
  .rank-badge.bg-silver { background-color: #C0C0C0; color: #000; }
  .rank-badge.bg-bronze { background-color: #CD7F32; color: #fff; }
  .rank-badge.bg-primary { background-color: #297fb8; color: #fff; }

  .avatar-sm {
      width: 32px;
      height: 32px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f4f8;
      border-radius: 50%;
  }

  .no-data-row {
      background-color: #f8f9fa;
      color: #6c757d;
  }

  /* Target Status Badge Colors */
  .bg-primary { background-color: #297fb8 !important; }
  .bg-success { background-color: #28a745 !important; }
  .bg-teal { background-color: #20c997 !important; }
  .bg-indigo { background-color: #6610f2 !important; }
  .bg-purple { background-color: #6f42c1 !important; }
  .bg-warning { background-color: #ffc107 !important; color: #000 !important; }
  .bg-orange { background-color: #fd7e14 !important; }
  .bg-coral { background-color: #ff6b6b !important; }
  .bg-danger { background-color: #dc3545 !important; }
  .bg-secondary { background-color: #6c757d !important; }

  .toast {
      max-width: 350px;
      overflow: hidden;
      font-size: 0.875rem;
      background-clip: padding-box;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
</style>