{% extends 'admin_base.html' %}
{% load static %}
{% block content %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Marketer Profile</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
        <li class="breadcrumb-item">Marketers</li>
        <li class="breadcrumb-item active">{{ marketer.full_name }}</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->

  <section class="section profile">
    <div class="row">
      <div class="col-xl-4">
        <div class="card">
          <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
            {% if marketer.profile_image %}
              <img src="{{ marketer.profile_image.url }}" alt="{{ marketer.full_name }} Profile" class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
            {% else %}
              <img src="{% static 'assets/img/profile_avatar.jpeg' %}" alt="Avatar" class="rounded-circle mb-3" style="width: 150px; height: 150px;">
            {% endif %}
            <h2>{{ marketer.full_name }}</h2>
            <h3>Marketer</h3>
            
            <div class="mt-4">
              <div class="d-flex justify-content-around w-100">
                <div class="text-center">
                  <h4 class="mb-0">{{ total_clients }}</h4>
                  <p class="small mb-0">Clients</p>
                </div>
                <div class="text-center">
                  <h4 class="mb-0">{{ total_sales|floatformat:"2g" }}</h4>
                  <p class="small mb-0">Total Sales (₦)</p>
                </div>
                <div class="text-center">
                  <h4 class="mb-0">{{ total_commissions|floatformat:"2g" }}</h4>
                  <p class="small mb-0">Commissions (₦)</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Performance Summary -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Performance Summary</h5>
            <div class="progress mb-3" style="height: 10px;">
              <div class="progress-bar bg-success" role="progressbar" 
                   style="width: {{ performance.target_achievement }}%" 
                   aria-valuenow="{{ performance.target_achievement }}" 
                   aria-valuemin="0" 
                   aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span class="small">Target Achievement</span>
              <span class="small">{{ performance.target_achievement }}%</span>
            </div>
            
            <div class="mt-4">
              <div class="d-flex justify-content-between mb-1">
                <span>Closed Deals:</span>
                <strong>{{ performance.closed_deals }}</strong>
              </div>
              <div class="d-flex justify-content-between mb-1">
                <span>Average Deal Size:</span>
                <strong>₦{{ performance.avg_deal_size|floatformat:"2g" }}</strong>
              </div>
              <div class="d-flex justify-content-between mb-1">
                <span>Commission Rate:</span>
                <strong>{{ commission_rate }}%</strong>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-8">
        <div class="card">
          <div class="card-body pt-3">
            <ul class="nav nav-tabs nav-tabs-bordered">
              <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profile-overview">Overview</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-clients">Clients</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-performance">Performance</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-edit">Edit Profile</button>
              </li>
            </ul>
            
            <div class="tab-content pt-2">
              <!-- Overview Tab -->
              <div class="tab-pane fade show active" id="profile-overview">
                <h5 class="card-title">About</h5>
                <p class="small fst-italic">{{ marketer.about|default:"No information provided" }}</p>

                <h5 class="card-title">Profile Details</h5>
                <div class="row">
                  <div class="col-lg-3 col-md-4 label">Full Name</div>
                  <div class="col-lg-9 col-md-8">{{ marketer.full_name }}</div>
                </div>
                <div class="row">
                  <div class="col-lg-3 col-md-4 label">Email</div>
                  <div class="col-lg-9 col-md-8">{{ marketer.email }}</div>
                </div>
                <div class="row">
                  <div class="col-lg-3 col-md-4 label">Phone</div>
                  <div class="col-lg-9 col-md-8">{{ marketer.phone }}</div>
                </div>
                <div class="row">
                  <div class="col-lg-3 col-md-4 label">Date Joined</div>
                  <div class="col-lg-9 col-md-8">{{ marketer.date_joined|date:"M d, Y" }}</div>
                </div>
              </div>

              <!-- Clients Tab -->
              <div class="tab-pane fade" id="profile-clients">
                <h5 class="card-title">Client Portfolio</h5>
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>Client</th>
                        <th>Location</th>
                        <th>Properties</th>
                        <th>Total Value (₦)</th>
                        <th>Last Purchase</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for client in clients %}
                        <tr>
                          <td>
                            <a href="{% url 'client_profile' client.id %}">
                              {{ client.full_name }}
                            </a>
                          </td>
                          <td>{{ client.country|default:"-" }}</td>
                          <td>{{ client.properties_count }}</td>
                          <td class="fw-bold">₦{{ client.total_value|floatformat:"2g" }}</td>
                          <td>{{ client.last_purchase|date:"M d, Y"|default:"-" }}</td>
                          <td>
                            <span class="badge bg-{% if client.is_active %}success{% else %}secondary{% endif %}">
                              {% if client.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                          </td>
                        </tr>
                      {% empty %}
                        <tr>
                          <td colspan="6" class="text-center py-4">
                            <i class="bi bi-people display-6 text-muted"></i>
                            <p class="mt-3">No clients assigned</p>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                
                <div class="mt-4">
                  <h5 class="card-title">Client Distribution</h5>
                  <div class="chart-container" style="position: relative; height:250px;">
                    <canvas id="clientDistributionChart"></canvas>
                  </div>
                </div>
              </div>

              <!-- Performance Tab -->
              <div class="tab-pane fade" id="profile-performance">
                <div class="row">
                  <div class="col-lg-6">
                    <h5 class="card-title">Sales Performance</h5>
                    <div class="chart-container" style="position: relative; height:300px;">
                      <canvas id="salesPerformanceChart"></canvas>
                    </div>
                  </div>
                  <div class="col-lg-6">
                    <h5 class="card-title">Commission Earnings</h5>
                    <div class="chart-container" style="position: relative; height:300px;">
                      <canvas id="commissionChart"></canvas>
                    </div>
                  </div>
                </div>
                
                <div class="mt-4">
                  <h5 class="card-title">Recent Transactions</h5>
                  <div class="table-responsive">
                    <table class="table table-sm table-hover">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Client</th>
                          <th>Estate</th>
                          <th>Amount (₦)</th>
                          <th>Commission (₦)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for transaction in recent_transactions %}
                          <tr>
                            <td>{{ transaction.transaction_date|date:"M d" }}</td>
                            <td>{{ transaction.client.full_name|truncatechars:12 }}</td>
                            <td>{{ transaction.allocation.estate.name|truncatechars:15 }}</td>
                            <td>{{ transaction.total_amount|floatformat:"2g" }}</td>
                            <td class="text-success fw-bold">{{ transaction.commission_earned|floatformat:"2g" }}</td>
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="5" class="text-center py-3 text-muted">
                              No recent transactions
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Edit Profile Tab (existing code) -->
              <div class="tab-pane fade" id="profile-edit">
                <!-- Existing edit form code -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Client Distribution Chart
    const clientCtx = document.getElementById('clientDistributionChart').getContext('2d');
    const clientChart = new Chart(clientCtx, {
      type: 'doughnut',
      data: {
        labels: ['Active Clients', 'New Clients', 'Inactive Clients'],
        datasets: [{
          data: [12, 5, 3],
          backgroundColor: ['#4154f1', '#2eca6a', '#ff771d'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          }
        }
      }
    });
    
    // Sales Performance Chart
    const salesCtx = document.getElementById('salesPerformanceChart').getContext('2d');
    const salesChart = new Chart(salesCtx, {
      type: 'bar',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
          label: 'Sales (₦)',
          data: [25000000, 32000000, 28000000, 41000000, 37000000, 52000000, 49000000, 61000000, 55000000, 72000000, 68000000, 79000000],
          backgroundColor: 'rgba(65, 84, 241, 0.7)',
          borderColor: '#4154f1',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₦' + (value/1000000).toFixed(0) + 'M';
              }
            }
          }
        }
      }
    });
    
    // Commission Chart
    const commissionCtx = document.getElementById('commissionChart').getContext('2d');
    const commissionChart = new Chart(commissionCtx, {
      type: 'line',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
          label: 'Commission (₦)',
          data: [1250000, 1600000, 1400000, 2050000, 1850000, 2600000, 2450000, 3050000, 2750000, 3600000, 3400000, 3950000],
          borderColor: '#2eca6a',
          backgroundColor: 'rgba(46, 202, 106, 0.1)',
          borderWidth: 3,
          pointRadius: 5,
          pointBackgroundColor: '#fff',
          pointBorderWidth: 2,
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₦' + (value/1000).toFixed(0) + 'K';
              }
            }
          }
        }
      }
    });
  });
</script>

<style>
  .profile-card img {
    border: 4px solid #f0f4f8;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }
  .progress {
    border-radius: 10px;
    height: 12px;
  }
  .progress-bar {
    border-radius: 10px;
  }
  .nav-tabs .nav-link {
    font-weight: 600;
    color: #495057;
  }
  .nav-tabs .nav-link.active {
    color: #4154f1;
    border-bottom: 3px solid #4154f1;
  }
  .table th {
    background-color: #f8f9fa;
    color: #495057;
    font-weight: 600;
  }
  .table-hover tbody tr:hover {
    background-color: rgba(65, 84, 241, 0.05);
  }
  .badge {
    font-weight: 500;
    padding: 0.5em 0.75em;
  }
</style>

{% endblock %}